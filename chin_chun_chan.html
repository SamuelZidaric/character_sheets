<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chin Chun Chan - Samurai Fighter</title>
    <style>
        :root {
            --bg-color: #1c1917;      
            --card-bg: #292524;        
            --text-main: #e7e5e4;     
            --text-muted: #a8a29e;    
            --accent: #c084fc;        
            --gold: #d97706;          
            --attack-bar-bg: #581c87; 
            --magic: #d8b4fe;         
            --success: #4ade80;       
            --warning: #ef4444;       
            --samurai-highlight: #9a3412; 
        }

        .attack-card {
            background-color: #2e1065; 
            border: 1px solid var(--accent); 
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--samurai-highlight);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-info h1 { margin: 0; font-size: 1.8em; color: var(--samurai-highlight); text-transform: uppercase; letter-spacing: 2px; }
        .header-info h2 { margin: 5px 0 0; font-size: 1em; color: var(--text-muted); }
        .rules-badge {
            display: inline-block;
            background: var(--accent);
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .level-control {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 50px;
        }

        input[type=range] { accent-color: var(--samurai-highlight); width: 200px; cursor: pointer; }
        .level-badge {
            background: var(--samurai-highlight);
            color: #fff;
            font-weight: bold;
            font-size: 1.5em;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--samurai-highlight);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1100px) { .dashboard { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #334155;
        }

        .card-title {
            color: var(--samurai-highlight);
            font-weight: bold;
            text-transform: uppercase;
            border-bottom: 1px solid #475569;
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- IMAGES --- */
        .char-img-container {
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 2px solid var(--accent);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            background: #000;
        }
        .char-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top center;
        }

        .pet-img-container {
            width: 100%;
            height: 150px;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--accent);
        }
        .pet-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- ROLEPLAY TEXT --- */
        .rp-block { margin-bottom: 12px; font-size: 0.85em; color: #cbd5e1; line-height: 1.4; }
        .rp-label { color: var(--gold); font-weight: bold; display: block; margin-bottom: 2px; font-size: 0.9em; text-transform: uppercase; }
        .rp-text { font-style: italic; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box {
            background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 8px; text-align: center;
        }
        .stat-label { font-size: 0.75em; color: var(--text-muted); display: block; }
        .stat-val { font-size: 1.2em; font-weight: bold; display: block; }
        .stat-mod { font-size: 0.9em; color: var(--samurai-highlight); }

        .skill-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.85em;
            border-bottom: 1px solid #334155;
        }
        .skill-prof { color: var(--samurai-highlight); font-weight: bold; }

        .combat-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .combat-stat {
            background: #0f172a; 
            width: 32%; 
            text-align: center; 
            padding: 10px 0;
            border-radius: 8px; 
            border: 1px solid #334155;
        }
        .c-val { display: block; font-size: 1.4em; font-weight: bold; color: var(--samurai-highlight); }
        .c-lbl { font-size: 0.7em; text-transform: uppercase; color: #888; }

        .attack-card { background: #334155; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--accent); }
        .attack-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        .attack-detail { font-size: 0.85em; color: #cbd5e1; font-style: italic; }
        .dmg-text { color: var(--samurai-highlight); }

        .feature-list { max-height: 450px; overflow-y: auto; padding-right: 5px; }
        .feature-item { margin-bottom: 12px; border-bottom: 1px solid #475569; padding-bottom: 8px; }
        .feat-name { color: var(--samurai-highlight); font-weight: bold; display: block; margin-bottom: 3px; }
        .feat-source { font-size: 0.75em; color: #94a3b8; background: #0f172a; padding: 2px 6px; border-radius: 4px; }
        .feat-desc { font-size: 0.85em; line-height: 1.4; color: #cbd5e1; margin-top: 5px; }

        .kw-action { color: #f472b6; font-weight: bold; }
        .kw-bonus { color: #fbbf24; font-weight: bold; }
        .kw-react { color: #60a5fa; font-weight: bold; }

        /* Resource Pips */
        .resource-display { margin-bottom: 15px; }
        .resource-row { display: flex; align-items: center; margin-bottom: 5px; }
        .resource-label { width: 100px; font-weight: bold; color: var(--magic); }
        .resource-pip {
            width: 14px; height: 14px; border-radius: 50%; background: var(--samurai-highlight);
            margin-right: 6px; box-shadow: 0 0 5px var(--samurai-highlight);
            cursor: pointer; display: inline-block;
        }
        .resource-pip.used {
            background: #334155;
            box-shadow: none;
            border: 1px solid #475569;
        }
        .resource-pip.action-surge {
            background: var(--gold);
            box-shadow: 0 0 5px var(--gold);
        }
        .resource-pip.second-wind {
            background: var(--success);
            box-shadow: 0 0 5px var(--success);
        }
        .resource-pip.breath {
            background: var(--accent);
            box-shadow: 0 0 5px var(--accent);
        }

        /* Pet Hover */
        .pet-tooltip {
            visibility: hidden; width: 300px; background-color: #0f172a; border: 2px solid var(--accent);
            border-radius: 8px; padding: 0; position: absolute; bottom: 110%; right: 0; z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,1); opacity: 0; transition: opacity 0.2s; pointer-events: none; text-align: left;
            overflow: hidden;
        }
        .pet-content { padding: 12px; }
        #pet-resource { position: relative; cursor: help; }
        #pet-resource:hover .pet-tooltip { visibility: visible; opacity: 1; }
        #pet-resource {height: auto; min-height: 300px; transition: all 0.3s ease; }

        /* Stat Block inside Tooltip */
        .sb-header { border-bottom: 1px solid var(--accent); margin-bottom: 8px; padding-bottom: 5px; }
        .sb-title { color: #facc15; font-weight: bold; font-size: 1.1em; text-transform: uppercase; }
        .sb-meta { color: #94a3b8; font-size: 0.8em; font-style: italic; }
        .sb-stats { display: flex; justify-content: space-between; background: #1e293b; padding: 5px; border-radius: 4px; margin-bottom: 8px; }
        .sb-val { color: #fff; font-weight: bold; }
        .sb-lbl { color: #94a3b8; font-size: 0.75em; }
        .sb-action { font-size: 0.9em; margin-bottom: 6px; line-height: 1.3; color: #cbd5e1; }
        .sb-action strong { color: #facc15; }

        .toggle-container { display: flex; align-items: center; font-size: 0.8em; color: #ccc; margin-left: 10px; }
        .toggle-checkbox { margin-right: 5px; accent-color: var(--magic); }

        /* BUFF PANEL */
        .buff-panel { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
        .buff-lbl {
            font-size: 0.75em; color: #94a3b8; background: #1e293b; padding: 4px 8px;
            border-radius: 4px; border: 1px solid #334155; display: flex; align-items: center; cursor: pointer;
        }
        .buff-lbl:hover { border-color: var(--samurai-highlight); color:#fff; }
        .buff-chk { margin-right: 5px; accent-color: var(--success); }

        /* Make attack cards look clickable */
        .attack-card { cursor: pointer; transition: transform 0.1s, border-color 0.1s; }
        .attack-card:active { transform: scale(0.98); }
        .attack-card:hover { border-color: #fff; }

        /* Back Button */
        .back-btn {
            background: #1e293b; border: 1px solid var(--accent);
            color: var(--accent); padding: 8px 16px; border-radius: 20px;
            font-weight: bold; cursor: pointer; text-decoration: none;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
        }
        .back-btn:hover { background: var(--accent); color: #fff; box-shadow: 0 0 10px var(--accent); }

        /* Short Rest Button */
        .rest-btn {
            background: #1e293b; border: 1px solid var(--samurai-highlight);
            color: var(--samurai-highlight); padding: 5px 15px; border-radius: 20px;
            font-weight: bold; cursor: pointer; margin-left: 15px;
            transition: all 0.2s;
        }
        .rest-btn:hover { background: var(--samurai-highlight); color: #fff; box-shadow: 0 0 10px var(--samurai-highlight); }

        /* Combat Log Console */
        #combat-log {
            background: #000; color: #4ade80; font-family: 'Consolas', monospace;
            font-size: 0.85em; padding: 10px; border-radius: 6px; border: 1px solid #334155;
            height: 120px; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column-reverse;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-crit { color: #facc15; font-weight: bold; text-shadow: 0 0 5px #facc15; }
        .log-fail { color: #f87171; }

        /* --- BACKSTORY MODAL --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--card-bg); width: 800px; max-width: 90%; max-height: 85vh;
            border-radius: 8px; border: 2px solid var(--samurai-highlight);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 20px; border-bottom: 1px solid #475569;
            display: flex; justify-content: space-between; align-items: center;
            background: #1e1b1a; border-radius: 6px 6px 0 0;
        }
        .modal-body {
            padding: 30px; overflow-y: auto; font-family: 'Georgia', serif; 
            line-height: 1.6; color: #d6d3d1; font-size: 1.1em;
        }
        .modal-close {
            background: transparent; border: none; color: #fff; font-size: 1.5em; cursor: pointer;
        }
        .story-title { color: var(--gold); font-size: 1.5em; font-weight: bold; margin-bottom: 10px; text-align: center; }
        .story-quote { 
            font-style: italic; color: var(--accent); border-left: 3px solid var(--accent); 
            padding-left: 15px; margin: 20px 0; background: rgba(88, 28, 135, 0.2); padding: 10px; border-radius: 4px;
        }
        .story-h3 { color: var(--samurai-highlight); margin-top: 25px; border-bottom: 1px solid #444; padding-bottom: 5px; }
    
        /* --- PET SLIDER STYLES --- */
        .pet-nav-container {
            position: relative;
            width: 100%;
        }

        /* Arrows */
        .pet-arrow {
            position: absolute;
            top: 40%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: var(--gold);
            border: 1px solid var(--gold);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-weight: bold;
            user-select: none;
            transition: all 0.2s;
        }
        .pet-arrow:hover { background: var(--gold); color: #000; box-shadow: 0 0 10px var(--gold); }
        .pet-arrow.left { left: 10px; }
        .pet-arrow.right { right: 10px; }

        /* The Spheres (Dots) */
        .pet-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        .pet-dot {
            width: 12px;
            height: 12px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pet-dot:hover { border-color: var(--accent); }
        .pet-dot.active {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
            transform: scale(1.2);
        }

        /* Size labels for the spheres */
        .pet-stage-label {
            text-align: center; 
            font-size: 0.8em; 
            color: var(--text-muted); 
            margin-bottom: 5px;
        }

        .ac-select {
            display: block;
            width: 90%;
            margin: 4px auto 0;
            background: #1e293b;
            color: #cbd5e1;
            border: 1px solid #475569;
            border-radius: 4px;
            font-size: 0.7em;
            cursor: pointer;
            text-align: center;
        }
        .ac-select:focus { outline: 1px solid var(--accent); }

        /* HP CONTAINER FIXES */
        .hp-container {
            position: relative;
            width: 100%;
            height: 35px; /* Fixed height for a clean bar look */
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 15px; /* Add spacing between stats and HP */
            box-shadow: inset 0 0 10px #000; /* Inner shadow for depth */
        }

        .hp-fill {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 100%;
            background: linear-gradient(90deg, #15803d 0%, #22c55e 100%); /* Green */
            transition: width 0.4s ease, background 0.4s ease;
            z-index: 1; /* Lowest z-index */
            opacity: 0.8;
        }
        .hp-fill.warning { background: linear-gradient(90deg, #854d0e 0%, #eab308 100%); } /* Yellow */
        .hp-fill.danger { background: linear-gradient(90deg, #7f1d1d 0%, #ef4444 100%); } /* Red */

        /* THIS IS THE NEW BLUE BAR STYLE */
        .hp-fill.temp {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            z-index: 2; /* Sits on top of green */
            box-shadow: 0 0 10px #3b82f6;
            opacity: 1;
        }

        .hp-text {
            position: relative;
            z-index: 20; /* Highest z-index to stay on top */
            display: flex;
            align-items: center;
            justify-content: center; /* Center the text perfectly */
            height: 100%;
            font-family: 'Consolas', monospace;
            letter-spacing: 1px;
            text-shadow: 0 0 5px #000, 0 0 5px #000; /* Shadow so text is readable over blue */
        }

        /* Temp HP Badge */
        .temp-hp-badge {
            position: absolute;
            top: -10px; right: -5px;
            background: #2563eb;
            color: #fff;
            border-radius: 50%;
            width: 24px; height: 24px;
            font-size: 0.75em;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #1e293b;
            box-shadow: 0 0 5px #2563eb;
            display: none; /* Hidden by default */
        }

        #current-hp {
            width: 60px; /* Give the input enough room */
            background: transparent;
            border: none;
            color: #fff;
            font-weight: bold;
            font-size: 1.4em;
            text-align: right;
            padding: 0;
            outline: none;
            margin-right: 5px;
            text-shadow: 0 0 5px #000;
        }

    </style>
</head>
<body>

<header>
    <a href="index.html" class="back-btn">← Back</a>
    <div class="header-info">
        <h1>Chin Chun Chan <span class="rules-badge">Samurai</span></h1>
        <h2>Fighter (Samurai) • Amethyst Dragonborn Outlander • <span style="color:var(--samurai-highlight)">w/ Baby Hook Horror</span></h2>
    </div>
    <div class="level-control">
        <label>LEVEL</label>
        <input type="range" id="levelRange" min="1" max="20" value="1" oninput="updateDashboard(this.value)">
        <div class="level-badge" id="lvl-badge">1</div>
        <button class="rest-btn" onclick="shortRest()">SHORT REST</button>
        <button class="rest-btn" onclick="longRest()" style="border-color:var(--accent); color:var(--accent);" title="Full Reset">LONG</button>
    </div>
</header>

<div class="dashboard">

    <div class="col-1">
        <div class="card">
            <div class="card-title">Identity</div>

            <div class="char-img-container">
                <img src="images/chin_chun_chan.png" alt="Chin Chun Chan" class="char-img">
            </div>

            <div class="rp-block">
                <span class="rp-label">Origin</span>
                <span class="rp-text">Abandoned by wealthy merchant parents at a tavern. Raised by the dwarven <strong>Clan of the Iron Blossom</strong>. Taught the blade by Master Thorin Ironwhisker (a dwarf who is "kind of a weeb").</span>
            </div>
            <div class="rp-block">
                <span class="rp-label">Personality</span>
                <span class="rp-text">Speaks in "profound wisdom" that is actually just obvious observations (e.g., "Hunger is when you haven't eaten"). Bows to everyone, including rocks.</span>
            </div>
            <div class="rp-block">
                <span class="rp-label">Ideals</span>
                <span class="rp-text"><strong>Enlightenment:</strong> "To know light, one must also know darkness." That is why I walked into this cave.</span>
            </div>
            <div class="rp-block">
                <span class="rp-label">Bonds</span>
                <span class="rp-text">My nagitana, <strong>"Sharp Friend"</strong>. My adoptive dwarf family. Marcus Gallus (my baby Hook Horror).</span>
            </div>
            <div class="rp-block" style="margin-bottom:0;">
                <span class="rp-label">Flaws</span>
                <span class="rp-text" style="color:var(--warning)">Believes he is a master flute player (he is terrible). Thinks his breath weapon is just "breathing really hard".</span>
            </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #1e1b1a 0%, #2e1065 100%); border: 2px solid var(--gold); cursor: pointer; transition: all 0.3s;" onclick="toggleModal('backstory-modal')" onmouseover="this.style.boxShadow='0 0 20px var(--gold)'; this.style.transform='scale(1.02)';" onmouseout="this.style.boxShadow='none'; this.style.transform='scale(1)';">
            <div style="text-align: center; padding: 15px 0;">
                <div style="color: var(--gold); font-size: 1.3em; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;">BOOK OF WISDOM</div>
                <div style="color: var(--accent); font-style: italic; font-size: 0.9em;">"The Definitely True and Not At All Embellished Story"</div>
                <div style="color: #94a3b8; font-size: 0.8em; margin-top: 10px;">Click to read the full backstory</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">Active Features & Feats</div>
            <div class="feature-list" id="features-container">
            </div>
        </div>
    </div>

    <div class="col-2">
        <div class="card" style="padding:10px; background:#0f172a;">
            <div class="card-title" style="margin:0 0 5px 0; border:none; font-size:0.8em;">Combat Log</div>
            <div id="combat-log">
                <div class="log-entry">> System Ready...</div>
            </div>
        </div>
        <div class="card">
            <div class="combat-bar">
                <div class="combat-stat">
                    <span class="c-lbl">AC</span>
                    <span class="c-val" id="ac-val">17</span>
                    <select id="armorSelect" onchange="updateDashboard(document.getElementById('levelRange').value)" class="ac-select">
                        <option value="16" selected>Chain (16)</option>
                        <option value="17">Splint (17)</option>
                        <option value="18">Plate (18)</option>
                    </select>
                </div>                
                <div class="combat-stat"><span class="c-lbl">Init</span><span class="c-val" id="init-val">+2</span></div>
                <div class="combat-stat"><span class="c-lbl">Speed</span><span class="c-val">9m</span></div>            
            </div> 
            <div style="margin-bottom: 15px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
                    <span class="card-title" style="border:none; margin:0; padding:0; font-size:1em;">Hit Points</span>
                    <span id="temp-hp-display" class="temp-hp-badge" style="position:static; display:none;">0</span>
                </div>
                
                <div class="hp-container">
                    <div id="hp-bar" class="hp-fill"></div>
                    <div id="hp-bar-temp" class="hp-fill temp" style="width:0%; display:none;"></div>
                    <div class="hp-text">
                        <input type="number" id="current-hp" value="49" onchange="updateHpBar()">
                        <span style="font-size:1.1em; color:#94a3b8; margin: 0 5px;">/</span>
                        <span id="max-hp" style="font-size:1.4em; color:#94a3b8;">49</span>
                    </div>
                </div>
            </div>

            <div class="card-title">Attacks</div>

            <div class="buff-panel">
                <label class="buff-lbl" id="fs-toggle-lbl" style="display:none;">
                    <input type="checkbox" id="buffFighting" class="buff-chk" onchange="updateDashboard(document.getElementById('levelRange').value)"> Fighting Spirit
                </label>
                
                <label class="buff-lbl" id="gwm-toggle" style="display:none; border-color:var(--warning);">
                    <input type="checkbox" id="buffGWM" class="buff-chk" style="accent-color:var(--warning);" onchange="updateDashboard(document.getElementById('levelRange').value)"> GWM (-5/+10)
                </label>
            </div>

            <div class="attack-card" onclick="rollAttack('Sharp Friend', 'wep1-hit', 'wep1-dmg')">
                <div class="attack-header">
                    <span>NAGINATA <span style="font-size:0.8em; color:#888;">(Glaive, Reach 10ft)</span></span>
                    <span id="wep1-hit" style="color:var(--success);">+5 Hit</span>
                </div>
                <div class="attack-detail">
                    Damage: <span class="dmg-text" id="wep1-dmg">1d10+3</span> Slashing<br>
                    <span id="wep1-desc" style="font-size:0.9em; color:#cbd5e1">The "No." Stick. Hit enemies before they reach you.</span>
                </div>
            </div>

            <div class="attack-card" id="pam-attack" style="display:none; border-left-color: var(--warning);" onclick="rollAttack('Pommel Strike', 'wep1-hit', 'pam-dmg')">
                <div class="attack-header">
                    <span>POMMEL STRIKE <span style="font-size:0.8em; color:#888;">(Bonus Action)</span></span>
                    <span id="pam-hit" style="color:var(--success);">+5 Hit</span>
                </div>
                <div class="attack-detail">
                    Damage: <span class="dmg-text" id="pam-dmg">1d4+3</span> Bludgeoning<br>
                    <span style="font-size:0.9em; color:#cbd5e1">Use the blunt end to smack them.</span>
                </div>
            </div>

            <div class="attack-card" style="border-left-color: var(--accent);" onclick="rollBreathWeapon()">
                <div class="attack-header">
                    <span>BREATH WEAPON <span style="font-size:0.8em; color:#888;">(Amethyst, 15ft Cone)</span></span>
                    <span id="breath-dc" style="color:var(--magic);">DC 14</span>
                </div>
                <div class="attack-detail">
                    Damage: <span class="dmg-text" id="breath-dmg" style="color:var(--magic)">2d10</span> Force (DEX Save for half)
                </div>
            </div>

            <div class="attack-card" style="border-left-color: var(--gold);" onclick="rollAttack('Longbow', 'wep3-hit', 'wep3-dmg')">
                <div class="attack-header">
                    <span>LONGBOW <span style="font-size:0.8em; color:#888;">(Range 150/600ft)</span></span>
                    <span id="wep3-hit" style="color:var(--success);">+5 Hit</span>
                </div>
                <div class="attack-detail">
                    Damage: <span class="dmg-text" id="wep3-dmg">1d8+2</span> Piercing
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Resources</div>

            <div class="attack-card" style="border-left-color: var(--samurai-highlight);" id="fighting-spirit-resource">
                <div class="attack-header">
                    <span>Fighting Spirit</span>
                    <div id="fighting-spirit-pips"></div>
                </div>
                <div class="attack-detail"><span class="kw-bonus">Bonus Action</span>. Advantage on attacks + <span id="temp-hp-val">5</span> Temp HP. Until end of turn.</div>
            </div>

            <div class="attack-card" style="border-left-color: var(--gold);">
                <div class="attack-header">
                    <span>Action Surge</span>
                    <div id="action-surge-pips"></div>
                </div>
                <div class="attack-detail"><span class="kw-action">Free Action</span>. Take one additional Action. Recharges on Short Rest.</div>
            </div>

            <div class="attack-card" style="border-left-color: var(--success);">
                <div class="attack-header">
                    <span>Second Wind</span>
                    <div id="second-wind-pips"></div>
                </div>
                <div class="attack-detail"><span class="kw-bonus">Bonus Action</span>. Heal <span id="second-wind-heal">1d10+5</span> HP. Recharges on Short Rest.</div>
            </div>

            <div class="attack-card" style="border-left-color: var(--accent);">
                <div class="attack-header">
                    <span>Breath Weapon</span>
                    <div id="breath-pips"></div>
                </div>
                <div class="attack-detail"><span class="kw-action">Action</span>. 15ft Cone, DEX Save. 2d10 Force damage. Recharges on Long Rest.</div>
            </div>

            <div class="attack-card" style="border-left-color: var(--magic); display:none;" id="gem-flight-resource">
                <div class="attack-header">
                    <span>Gem Flight</span>
                    <div id="gem-flight-pips"></div>
                </div>
                <div class="attack-detail"><span class="kw-bonus">Bonus Action</span>. Gain 30ft fly speed for 10 minutes. Recharges on Long Rest.</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Psionic Mind</div>
            <div style="font-size:0.9em; color:#cbd5e1;">
                <span style="color:var(--accent); font-weight:bold;">"Thinking Loudly" (Telepathy 9m)</span><br>
                <span style="font-size:0.85em; color:#94a3b8;">You can send telepathic messages to creatures within 9m. Chin calls this "thinking really loudly at people". Often used to tell monsters that "Violence is just spicy peace".</span>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Resistances & Immunities</div>
            <div style="font-size:0.9em; color:#cbd5e1;">
                <div style="margin-bottom:8px;">
                    <span style="color:var(--accent); font-weight:bold;">Force Resistance</span><br>
                    <span style="font-size:0.85em; color:#94a3b8;">Half damage from Force damage (Amethyst Dragonborn)</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-3">
        
        <div class="card">
            <div class="card-title">Attributes</div>
            <div class="stat-grid">
                <div class="stat-box" style="border-color:var(--samurai-highlight)"><span class="stat-label" style="color:var(--samurai-highlight)">STR</span><span class="stat-val" id="str">16</span><span class="stat-mod" id="str-mod">+3</span></div>
                
                <div class="stat-box"><span class="stat-label">DEX</span><span class="stat-val" id="dex">14</span><span class="stat-mod" id="dex-mod">+2</span></div>
                
                <div class="stat-box" style="border-color:var(--success)"><span class="stat-label" style="color:var(--success)">CON</span><span class="stat-val" id="con">16</span><span class="stat-mod" id="con-mod">+3</span></div>
                
                <div class="stat-box"><span class="stat-label">INT</span><span class="stat-val" id="int">10</span><span class="stat-mod" id="int-mod">+0</span></div>
                
                <div class="stat-box" id="wis-box"><span class="stat-label" id="wis-lbl">WIS</span><span class="stat-val" id="wis">14</span><span class="stat-mod" id="wis-mod">+2</span></div>
                
                <div class="stat-box"><span class="stat-label">CHA</span><span class="stat-val" id="cha">10</span><span class="stat-mod" id="cha-mod">+0</span></div>
            </div>
            <div style="text-align:center; font-size:0.9em; color:#888;">
                Proficiency: <strong style="color:var(--text-main)" id="prof-bonus">+3</strong>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">Saving Throws</div>
            <div id="saves-container"></div>
        </div>

        <div class="card">
            <div class="card-title">Skills</div>
            <div id="skills-container"></div>
            <div style="font-size:0.75em; color:#888; margin-top:8px;">
                ★ = Proficient
            </div>
        </div>

        <div class="card" id="pet-resource">
            <div class="card-title" style="display:flex; justify-content:space-between;">
                <span>Companion</span>
                <span id="pet-stage-name" style="color:var(--text-muted); font-size:0.7em;">INFANT</span>
            </div>

            <div class="pet-nav-container">
                <div class="pet-arrow left" onclick="changePetStage(-1)">❮</div>
                <div class="pet-arrow right" onclick="changePetStage(1)">❯</div>

                <div class="pet-img-container" style="height: 250px;">
                    <img src="images/hook_horror_infant.png" id="pet-img" alt="Marcus Gallus" class="pet-img">
                </div>
            </div>

            <div class="pet-dots">
                <div class="pet-dot active" onclick="setPetStage(0)" title="Infant (Tiny)"></div>
                <div class="pet-dot" onclick="setPetStage(1)" title="Young (Small)"></div>
                <div class="pet-dot" onclick="setPetStage(2)" title="Juvenile (Medium)"></div>
                <div class="pet-dot" onclick="setPetStage(3)" title="Adult (Large)"></div>
            </div>

            <div style="text-align:center; margin-bottom:10px;">
                <span style="color:var(--accent); font-weight:bold; font-size:1.1em;">Marcus Gallus</span><br>
                <span id="pet-size-age" style="font-size:0.85em; color:#94a3b8;">Tiny Monstrosity (1 month)</span>
            </div>

            <div class="attack-detail" style="background:transparent; border:none; padding:0;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; padding:5px; background:#0f172a; border-radius:4px; border:1px solid #334155;">
                    <div><strong style="color:var(--gold)">AC</strong> <span id="pet-ac">10</span></div>
                    <div><strong style="color:var(--success)">HP</strong> <span id="pet-hp">4</span></div>
                    <div><strong style="color:#cbd5e1">SPD</strong> <span id="pet-spd">10ft</span></div>
                </div>

                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px; margin-bottom:10px; text-align:center; background:#1e293b; padding:8px; border-radius:4px; font-size:0.9em;">
                    <div><span style="color:#94a3b8; font-size:0.8em; display:block;">STR</span><span id="pet-str" style="color:#fff; font-weight:bold;">9 (-1)</span></div>
                    <div><span style="color:#94a3b8; font-size:0.8em; display:block;">DEX</span><span id="pet-dex" style="color:#fff; font-weight:bold;">10 (+0)</span></div>
                    <div><span style="color:#94a3b8; font-size:0.8em; display:block;">CON</span><span id="pet-con" style="color:#fff; font-weight:bold;">10 (+0)</span></div>
                    
                    <div><span style="color:#94a3b8; font-size:0.8em; display:block;">INT</span><span id="pet-int" style="color:#fff; font-weight:bold;">4 (-3)</span></div>
                    <div><span style="color:#94a3b8; font-size:0.8em; display:block;">WIS</span><span id="pet-wis" style="color:#fff; font-weight:bold;">6 (-2)</span></div>
                    <div><span style="color:#94a3b8; font-size:0.8em; display:block;">CHA</span><span id="pet-cha" style="color:#fff; font-weight:bold;">3 (-4)</span></div>
                </div>
                
                <div style="border-top:1px solid #334155; padding-top:8px;">
                    <div id="pet-attack-line" style="margin-bottom:4px; font-size:0.95em;">
                        <span style="color:#94a3b8;">No effective attacks.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="backstory-modal" class="modal-overlay" onclick="if(event.target === this) toggleModal('backstory-modal')">
        <div class="modal-content" style="width: 900px;">
            <div class="modal-header">
                <span style="font-weight:bold; color:var(--gold); text-transform:uppercase;">The Book of Infinite Wisdom</span>
                <button class="modal-close" onclick="toggleModal('backstory-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="story-title">THE DEFINITELY TRUE AND NOT AT ALL EMBELLISHED STORY OF CHIN CHUN CHAN</div>

                <div class="story-quote">
                    "If you think about it, breathing is just mouth wind but on the inside."<br>
                    <span style="font-size:0.9em; color:#94a3b8;">- Chin Chun Chan, age 7, right before almost drowning</span>
                </div>

                <h3 class="story-h3">Chapter 1: The Oopsie</h3>
                <p>So there were these two dragonborn, right? Chin's parents. Wealthy merchants. Real fancy types. The kind of people who would absolutely, definitely, 100% remember to bring their child with them when leaving a tavern. Except, plot twist: they didn't.</p>

                <p>Now, you might be thinking, "How do you forget a whole baby dragon?" And that's a great question. The answer is: they were REALLY into this jade salesman's pitch. Like, really into it. The guy was describing the jade and Chin's dad just kept saying "wow" and nodding. For three hours. Chin's mom had already fallen asleep standing up.</p>

                <p>Baby Chin was in the corner, wrapped in a blanket that was frankly too expensive for a tavern floor, doing what baby dragons do best: existing quietly and being very easy to forget about. He wasn't even crying. He was just... vibing. Already showing signs of his future philosophical prowess by staring at a wall and probably thinking something like "wall is wall because it is not not-wall."</p>

                <p>His parents left at dawn. They got THREE KINGDOMS AWAY before Chin's mom went, "Wait, didn't we have a thing?"</p>

                <p><em>"What thing?"</em></p>

                <p><em>"You know... a small thing. A purple scaly thing that called us mama and papa."</em></p>

                <p><em>"Oh. OH. OH NO."</em></p>

                <p>They did not go back. Instead, they convinced themselves that the dwarves would probably do a better job anyway. This is what we call "coping" and also "being terrible parents." But it's fine. Everything's fine. Chin's fine. Probably. Let's continue.</p>

                <h3 class="story-h3">Chapter 2: The Dwarves Were Confused But They Had Spirit</h3>
                <p>The dwarves found baby Chin the next morning. He was still staring at the wall. One of them, a dwarf named Grungi, poked him with a stick. Chin turned around and said his first words: <strong>"Stick is long rock."</strong></p>

                <p>The dwarves looked at each other. "Well," said Grungi, "he's not wrong."</p>

                <p>And so the Clan of the Iron Blossom adopted Chin. They tried to find his parents. They asked around. They put up posters. The posters said <em>"FOUND: One (1) Purple Baby Dragon. Very Stupid. Please Claim."</em> Nobody claimed him. The dwarves shrugged and decided he was theirs now.</p>

                <p>Growing up, Chin was... special. While other dwarven children learned to count ore, Chin would announce things like "One is the first number, but zero comes before it, which means nothing is the most important something." The dwarves would nod slowly and back away.</p>

                <p>When he was 8, Chin discovered philosophy. Or rather, he discovered what he thought was philosophy but was actually just saying obvious things in a dramatic voice. "Father Thorin," he once said, standing on a rock dramatically, "have you ever noticed that when you're hungry, it's because you haven't eaten?"</p>

                <p>Thorin, who had become his reluctant guardian/teacher, stared into the middle distance. "Yes, Chin. That's... that's what hunger is."</p>

                <p>"Fascinating," Chin whispered, writing it down in his "Book of Infinite Wisdom" (which was just a notebook he'd stolen from the tavern).</p>

                <h3 class="story-h3">Chapter 3: The Samurai Arc (This Is Where It Gets Weird)</h3>
                <p>Master Thorin Ironwhisker was the one dwarf who had traveled to distant lands. He'd been to Kara-Tur. He'd learned the way of the samurai. He had a nagitana. He was, in dwarf terms, "kind of a weeb." But nobody said that to his face because he would absolutely kick your ass.</p>

                <p>Thorin looked at teenage Chin - tall, purple, scales gleaming, already talking about how "swords are just sharp waiting sticks" - and thought, "You know what? This kid needs discipline. And a weapon. Preferably one he can't hurt himself with, but we'll work with what we got."</p>

                <p>So Thorin taught Chin the way of the samurai. Sort of. Mostly he taught him how to swing a sword without cutting his own tail off. Chin took to it like a duck to water, if the duck was very confident but also very stupid and the water was actually a complicated martial art.</p>

                <p><em>"The blade is an extension of your soul,"</em> Thorin would say.</p>

                <p>"Yes, Master," Chin would respond, nodding sagely. "So if I drop my sword, I've dropped my soul. Which means my soul is on the floor. Which means the floor has my soul. The floor is me."</p>

                <p>"That's not—" Thorin would start, then stop, sigh deeply, and just continue the lesson.</p>

                <p>But here's the thing: Chin was actually GOOD at fighting. Really good. His body understood what his brain couldn't. He could parry, strike, dodge, and counter like he'd been born with a sword in his hand. Which he hadn't been, obviously, because that would be a serious medical emergency. But you get the point.</p>

                <p>The dwarves would watch him train and go, "How is he so good at this but also so... like that?" Nobody had an answer. It was one of life's great mysteries. Like why the tavern ale was both terrible and also everyone's favorite drink.</p>

                <h3 class="story-h3">Chapter 4: The Greatest Hits (Chin's Dumbest Moments)</h3>

                <p><strong style="color:var(--gold)">Age 12: The Meditation Incident</strong><br>
                Chin decided to meditate to "become one with the universe." He sat in the meditation pose for six hours. Everyone thought he'd achieved enlightenment. Turned out he'd just forgotten how to stand up and was too embarrassed to ask for help.</p>

                <p><strong style="color:var(--gold)">Age 15: The Breathing Revelation</strong><br>
                Chin burst into the tavern and announced, "I have discovered the secret of life!" Everyone stopped. He had their full attention. He took a deep breath and said: "If you stop breathing, you die. But if you keep breathing, you don't. This is the way."<br>
                Someone threw a boot at him.</p>

                <p><strong style="color:var(--gold)">Age 18: The Flute Situation</strong><br>
                A traveling bard left a flute at the tavern. Chin found it. Chin decided he was now a flute player. He was not a flute player. He is still not a flute player. But he plays that flute with the confidence of a man who thinks making noise is the same as making music. The dwarves have learned to leave the area when he pulls it out.</p>

                <p><strong style="color:var(--gold)">Age 19: The "Deep Thoughts" Phase</strong><br>
                Chin started sharing daily wisdom with anyone who would listen (and many who wouldn't):</p>
                <ul>
                    <li>"The mountain is high because the ground is low."</li>
                    <li>"If you're not here, you're somewhere else. Unless you're nowhere. But nowhere is somewhere. I think."</li>
                    <li>"Doors are just walls that know when to move."</li>
                    <li>"Sleep is just time travel but slower and you can't choose where you go. Which is your bed. You go to your bed."</li>
                </ul>
                <p>The dwarves started pretending to be busy whenever they saw him approaching with "the look" - you know, that look someone gets when they're about to say something they think is profound.</p>

                <h3 class="story-h3">Chapter 5: The Terrible Decision (Or: How Chin Ended Up In The Literal Worst Place)</h3>
                <p>At age 20-something (Chin had lost count because "time is just now happening repeatedly"), he decided he needed to see the world. The dwarves were sad but also slightly relieved. Master Thorin gave him his blessing, his nagitana, and a very long list of things not to do, which Chin immediately lost.</p>

                <p>Chin became a caravan guard. He was actually pretty good at it. Bandits would attack, Chin would fight them off while saying things like "Violence is just aggressive peace," and everyone would be very confused but also safe, so it worked out.</p>

                <p>Then came The Incident.</p>

                <p>The caravan was camped near a massive cave system. The locals called it the "Throat of the World" and warned everyone to stay away because it was dangerous and went down into the Underdark and probably had demons and definitely had things that wanted to eat you.</p>

                <p>Chin, staring at the cave entrance, had a thought. This was already concerning.</p>

                <p><em>"To know light,"</em> he announced to nobody in particular, <em>"one must also know darkness."</em></p>

                <p>"That's... actually kind of right?" said one of the merchants.</p>

                <p>"Therefore," Chin continued, pulling out his nagitana and his one torch, "I must go into this cave."</p>

                <p>"Wait, that doesn't follow—" the merchant started.</p>

                <p>But Chin was already walking into the cave, his torch held high, probably humming off-key on his flute. His last words to the surface world were: <em>"I shall return with enlightenment! Or I will not return! One of these will definitely happen! Perhaps both! Can you return without returning? I will contemplate this in the cave!"</em></p>

                <h3 class="story-h3">Chapter 6: Chin's Excellent Underdark Adventure (It Was Not Excellent)</h3>
                <p>So here's the thing about the Underdark: it's really big, really dark, and really easy to get lost in. Especially if you're Chin and your navigation strategy is "follow the vibes."</p>

                <p><strong>Day 1:</strong> "This cave goes down. Down is a direction. I am going in a direction. Therefore, I am not lost."</p>

                <p><strong>Day 5:</strong> "I have not seen the sun. But I have also not seen the moon. This means I am in perfect balance."</p>

                <p><strong>Day 12:</strong> "If I can't find the way back, does that mean I'm on a new path forward? This is wisdom."</p>

                <p><strong>Day 20:</strong> "Why is there a mushroom that's glowing? Why are there so many mushrooms? Am I in a mushroom? Is the world a mushroom? I should write this down."</p>

                <p>Chin survived through a combination of luck, skill, and the fact that even Underdark monsters looked at him and went "...you know what, this one's not worth it." He'd try to communicate with them using his Psionic Mind, sending telepathic messages like "Violence is just spicy peace" or "Do you also think about how rocks are just the earth's teeth?"</p>

                <p>A hook horror once received a telepathic message from Chin that said "What if water is just really wet air?" and simply walked away. Just turned around and left. Didn't even try to eat him.</p>

                <p>Chin ate strange mushrooms (some were poisonous, he got better), fought off cave fishers (while yelling "Your fishing techniques lack honor!"), and once had a very confusing conversation with a flumph who afterwards went to therapy.</p>

                <h3 class="story-h3">Chapter 7: The Present (Where We Find Our "Hero")</h3>
                <p>Currently, Chin Chun Chan is still in the Underdark. He has been there for approximately 40 days, though he's lost count because he doesn't really understand how calendars work. He carries with him:</p>
                <ul>
                    <li>His nagitana, which he's named "Sharp Friend"</li>
                    <li>A falcon feather from his dwarf family, which he sometimes talks to</li>
                    <li>His flute, which has caused more damage to enemy morale than his sword</li>
                    <li>A notebook full of "wisdom" that would make any philosopher weep</li>
                    <li>Approximately 47 rations (he keeps finding more in his bag and has no idea where they came from)</li>
                    <li>A bear trap that he's forgotten he's carrying</li>
                </ul>

                <p>He has recently stumbled upon what appears to be other prisoners or refugees or possibly very lost adventurers. He has decided they are his new friends, whether they like it or not. He has already shared three pieces of wisdom with them:</p>
                <ol>
                    <li>"We are in the dark, but we have eyes, so we are not truly blind. Unless we close our eyes. Then we are blind. But we can open them again. This is the cycle."</li>
                    <li>"Demons are just angry friends we haven't befriended yet. We should try to befriend them. With swords."</li>
                    <li>"If we die down here, we will be very dead. But if we don't die, we won't be dead. I think we should choose the second one."</li>
                </ol>
                <p>His new companions are already exhausted.</p>

                <h3 class="story-h3">Chin's Actual Philosophy (The Real Stupid Stuff)</h3>

                <p><strong style="color:var(--accent)">On Death:</strong><br>
                "When you die, you stop being alive, which is basically the same as being not alive, which is death. So death is death. I am very smart."</p>

                <p><strong style="color:var(--accent)">On Combat:</strong><br>
                "The enemy cannot defeat you if you defeat them first. This is because they will be defeated. By you. Who defeated them."</p>

                <p><strong style="color:var(--accent)">On Food:</strong><br>
                "Eating is just chewing until the food is gone into your stomach. The stomach is like a food jail. But the food wanted to go there. Or did it? I will think about this while I eat."</p>

                <p><strong style="color:var(--accent)">On The Underdark:</strong><br>
                "The Underdark is called the Underdark because it is under things and dark. If it was above things, it would be the Overdark. If it was bright, it would be the Underlight. But it is neither. This proves something. I'm not sure what."</p>

                <p><strong style="color:var(--accent)">On His Sword:</strong><br>
                "Sharp Friend is very sharp. This is why I named them Sharp Friend. The sharp part. Not the friend part. Although they are my friend. Because I said so. We are friends, right Sharp Friend?" (He then holds the sword to his ear like it's answering.)</p>

                <p><strong style="color:var(--accent)">On Being Lost:</strong><br>
                "I am not lost. I am exactly where I am. Which is here. Here is a place. Therefore I am in a place. Checkmate, geography."</p>

                <p><strong style="color:var(--accent)">On Strategy:</strong><br>
                "Master Thorin said 'Know your enemy.' But I don't know any of these enemies. Therefore, every battle is a surprise party. Except I'm the one surprising them. By hitting them."</p>

                <p><strong style="color:var(--accent)">On Why He's Really Down Here:</strong><br>
                "I came to the cave to find enlightenment. I have not found it yet. But I have found many mushrooms and some scary creatures. Perhaps the enlightenment was the mushrooms we ate along the way. No wait, those made me sick. Nevermind."</p>

                <h3 class="story-h3">Fun Facts About Chin</h3>
                <ul>
                    <li>He thinks his breath weapon is him "breathing really hard" and doesn't understand it's actually a magical ability</li>
                    <li>He once tried to meditate for three days but actually just fell asleep standing up</li>
                    <li>He calls his Psionic Mind ability "thinking really loudly at people"</li>
                    <li>He doesn't know what his parents look like and at this point he's too embarrassed to ask</li>
                    <li>The dwarves gave him that falcon feather as a tracking device but he thinks it's a sacred symbol</li>
                    <li>He has never successfully played a song on the flute but believes he has played thousands</li>
                    <li>When he uses Action Surge, he yells "DOUBLE TIME!" because he thinks he's moving twice as fast (he's not, he just gets an extra action)</li>
                    <li>He bows to everyone, including enemies, mushrooms, and once to a particularly interesting rock</li>
                </ul>

                <h3 class="story-h3">Epilogue: What Even Is This Story</h3>
                <p>So yeah. That's Chin Chun Chan. A purple dragonborn samurai who was abandoned at a tavern, raised by dwarves who taught him to fight but couldn't teach him to think, and who walked into one of the most dangerous places in the world because he had a vaguely philosophical thought one evening.</p>

                <p>He's honorable but stupid. He's skilled but clueless. He speaks in what he thinks is profound wisdom but is actually just observations about how reality works, except somehow dumber.</p>

                <p>He will protect his friends with his life. He will face demons with courage. He will share his wisdom with anyone who asks (and everyone who doesn't). And he will absolutely, definitely, 100% not understand what's going on at any given moment.</p>

                <p style="text-align:center; margin-top:30px; font-size:1.1em; color:var(--gold);">Welcome to the Out of the Abyss campaign. Chin Chun Chan is ready to not understand it.</p>

                <div class="story-quote" style="margin-top:30px; text-align:center;">
                    "The journey of a thousand miles begins with a single step. Then another step. Then more steps. That's how walking works. This is wisdom."<br>
                    <span style="font-size:0.9em; color:#94a3b8;">- Chin Chun Chan, probably right now</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATA ---
    const allSkills = [
        {name: "Acrobatics", ability: "dex"}, {name: "Animal Handling", ability: "wis"}, {name: "Arcana", ability: "int"},
        {name: "Athletics", ability: "str"}, {name: "Deception", ability: "cha"}, {name: "History", ability: "int"},
        {name: "Insight", ability: "wis"}, {name: "Intimidation", ability: "cha"}, {name: "Investigation", ability: "int"},
        {name: "Medicine", ability: "wis"}, {name: "Nature", ability: "int"}, {name: "Perception", ability: "wis"},
        {name: "Performance", ability: "cha"}, {name: "Persuasion", ability: "cha"}, {name: "Religion", ability: "int"},
        {name: "Sleight of Hand", ability: "dex"}, {name: "Stealth", ability: "dex"}, {name: "Survival", ability: "wis"}
    ];

    // Samurai gets Persuasion or History + Outlander background skills
    const proficientSkills = ["Athletics", "Perception", "Survival", "Persuasion", "Intimidation"];

    const levels = {
        1: {
            str: 16, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 2, hp: 13,
            fightingSpirit: 3, actionSurge: 0, secondWind: 1,
            features: [
                {name: "Amethyst Dragonborn", source: "Species", desc: "Force Resistance. Breath Weapon. Psionic Mind."},
                {name: "Background: The Oopsie", source: "History", desc: "Abandoned at a tavern, raised by dwarves."},
                {name: "Fighting Style: Defense", source: "Fighter 1", desc: "+1 AC while wearing armor."},
            ]
        },
        2: {
            str: 16, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 2, hp: 22,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1,
            features: [
                {name: "Action Surge", source: "Fighter 2", desc: "Take one additional Action on your turn. Recharges on Short Rest."}
            ]
        },
        3: {
            str: 16, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 2, hp: 31,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1,
            features: [
                {name: "Fighting Spirit", source: "Samurai 3", desc: "<span class='kw-bonus'>Bonus Action</span>. Gain Advantage on attacks & 5 Temp HP."},
            ]
        },
        4: {
            str: 16, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 2, hp: 40,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1,
            features: [
                {name: "Feat: Sentinel", source: "Fighter 4", desc: "<span class='kw-react'>Reaction</span>. 1. Hit = 0 Speed. 2. No Disengage. 3. Attack enemy hitting ally."}
            ]
        },
        5: {
            str: 16, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 3, hp: 49,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Extra Attack", source: "Fighter 5", desc: "Attack twice when taking the Attack action."},
                {name: "Gem Flight", source: "Amethyst Dragonborn 5", desc: "<span class='kw-bonus'>Bonus Action</span>. Gain 30ft fly speed for 10 minutes."}
            ]
        },
        6: {
            str: 16, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 3, hp: 58,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Feat: Polearm Master", source: "Fighter 6", desc: "1. OA triggered when enemy ENTERS reach. 2. Bonus Action attack (1d4)."}
            ]
        },
        7: {
            str: 16, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 3, hp: 67,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Elegant Courtier", source: "Samurai 7", desc: "Add WIS mod to Persuasion. Gain WIS Save Proficiency."}
            ]
        },
        8: {
            str: 18, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 3, hp: 76,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "ASI", source: "Fighter 8", desc: "+2 STR (now 18)."}
            ]
        },
        9: {
            str: 18, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 4, hp: 85,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Indomitable", source: "Fighter 9", desc: "Reroll a failed saving throw. 1/Long Rest."}
            ]
        },
        10: {
            str: 18, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 4, hp: 94,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Tireless Spirit", source: "Samurai 10", desc: "If you have 0 Fighting Spirit uses when rolling initiative, regain 1."}
            ]
        },
        11: {
            str: 18, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 4, hp: 103,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Extra Attack (x2)", source: "Fighter 11", desc: "Attack THREE times when taking the Attack action."}
            ]
        },
        12: {
            str: 20, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 4, hp: 112,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "ASI", source: "Fighter 12", desc: "+2 STR (Max 20). Essential for Sentinel accuracy."}
            ]
        },
        13: {
            str: 20, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 5, hp: 121,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Indomitable (x2)", source: "Fighter 13", desc: "Two uses per Long Rest."}
            ]
        },
        14: {
            str: 20, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 5, hp: 130,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Feat: Great Weapon Master", source: "Fighter 14", desc: "1. -5 Hit / +10 Dmg toggle. 2. Crit/Kill grants Bonus Action attack."}
            ]
        },
        15: {
            str: 20, dex: 12, con: 16, int: 8, wis: 14, cha: 8, prof: 5, hp: 139,
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "Rapid Strike", source: "Samurai 15", desc: "If you have Advantage, forego it on one attack to make an additional attack."}
            ]
        },
        16: {
            str: 20, dex: 12, con: 18, int: 8, wis: 14, cha: 8, prof: 5, hp: 164, // +2 CON adds retroactive HP
            fightingSpirit: 3, actionSurge: 1, secondWind: 1, gemFlight: true,
            features: [
                {name: "ASI", source: "Fighter 16", desc: "+2 CON (now 18). More HP for tanking."}
            ]
        },
        17: {
            str: 20, dex: 12, con: 18, int: 8, wis: 14, cha: 8, prof: 6, hp: 174,
            fightingSpirit: 3, actionSurge: 2, secondWind: 1, gemFlight: true,
            features: [
                {name: "Action Surge (x2)", source: "Fighter 17", desc: "Two uses per Short Rest."},
                {name: "Indomitable (x3)", source: "Fighter 17", desc: "Three uses per Long Rest."}
            ]
        },
        18: {
            str: 20, dex: 12, con: 18, int: 8, wis: 14, cha: 8, prof: 6, hp: 184,
            fightingSpirit: 3, actionSurge: 2, secondWind: 1, gemFlight: true,
            features: [
                {name: "Strength Before Death", source: "Samurai 18", desc: "<span class='kw-react'>Reaction</span>. If you hit 0 HP, take an immediate extra turn before falling unconscious."}
            ]
        },
        19: {
            str: 20, dex: 12, con: 20, int: 8, wis: 14, cha: 8, prof: 6, hp: 209, // +2 CON adds retroactive HP
            fightingSpirit: 3, actionSurge: 2, secondWind: 1, gemFlight: true,
            features: [
                {name: "ASI", source: "Fighter 19", desc: "+2 CON (Max 20). Maximum beef."}
            ]
        },
        20: {
            str: 20, dex: 12, con: 20, int: 8, wis: 14, cha: 8, prof: 6, hp: 224,
            fightingSpirit: 3, actionSurge: 2, secondWind: 1, gemFlight: true,
            features: [
                {name: "Extra Attack (x3)", source: "Fighter 20", desc: "Attack FOUR times when taking the Attack action."}
            ]
        }
    };

    function getMod(score) { return Math.floor((score - 10) / 2); }
    function fmtSign(n) { return n >= 0 ? "+" + n : n; }

    function updateDashboard(val) {
        // FIX: Renamed argument to 'val' to avoid conflict with 'lvl'
        let lvl = parseInt(val);

        document.getElementById('lvl-badge').innerText = lvl;
        let data = { ...levels[lvl] };

        // --- ATTRIBUTE BOX COLORING (WIS Logic) ---
        const wisBox = document.getElementById('wis-box');
        const wisLbl = document.getElementById('wis-lbl');
        
        // Level 7 Feature: Elegant Courtier (Gain WIS Save Proficiency)
        if (lvl >= 7) {
            wisBox.style.borderColor = 'var(--accent)';
            wisLbl.style.color = 'var(--accent)';
        } else {
            wisBox.style.borderColor = '#334155';
            wisLbl.style.color = '#a8a29e'; 
        }

        // --- READ INPUTS ---
        const fightingSpiritEl = document.getElementById('buffFighting');
        const hasFightingSpirit = fightingSpiritEl ? fightingSpiritEl.checked : false;

        // --- Accumulate Features ---
        let allFeatures = [];
        for (let i = 1; i <= lvl; i++) {
            if (levels[i].features) allFeatures = [...allFeatures, ...levels[i].features];
        }

        // --- Stats ---
        const mods = {
            str: getMod(data.str), dex: getMod(data.dex), con: getMod(data.con),
            int: getMod(data.int), wis: getMod(data.wis), cha: getMod(data.cha)
        };

        for (const [key, val] of Object.entries(data)) {
            if (['str','dex','con','int','wis','cha'].includes(key)) {
                document.getElementById(key).innerText = val;
                document.getElementById(`${key}-mod`).innerText = fmtSign(mods[key]);
            }
        }
        document.getElementById('prof-bonus').innerText = fmtSign(data.prof);

        // Initiative
        const initMod = mods.dex;
        document.getElementById('init-val').innerText = fmtSign(initMod);

        // --- Saving Throws (Fighter: STR and CON) ---
        const savesContainer = document.getElementById('saves-container');
        savesContainer.innerHTML = '';

        // At level 7, Elegant Courtier grants WIS save proficiency
        const hasWisSave = (lvl >= 7);

        const saves = [
            {name: "Strength", mod: mods.str, prof: true},
            {name: "Dexterity", mod: mods.dex, prof: false},
            {name: "Constitution", mod: mods.con, prof: true},
            {name: "Intelligence", mod: mods.int, prof: false},
            {name: "Wisdom", mod: mods.wis, prof: hasWisSave},
            {name: "Charisma", mod: mods.cha, prof: false}
        ];

        saves.forEach(s => {
            const total = s.mod + (s.prof ? data.prof : 0);
            const cls = s.prof ? 'skill-prof' : '';
            savesContainer.innerHTML += `<div class="skill-row"><span class="${cls}">${s.name}</span> <span class="${cls}">${fmtSign(total)}</span></div>`;
        });

        // --- Skills ---
        const skillsContainer = document.getElementById('skills-container');
        skillsContainer.innerHTML = '';

        allSkills.forEach(skill => {
            const mod = mods[skill.ability];
            const isProf = proficientSkills.includes(skill.name);
            let total = mod + (isProf ? data.prof : 0);

            // Elegant Courtier bonus for Persuasion at level 7+
            if (skill.name === "Persuasion" && lvl >= 7) {
                total += mods.wis;
            }

            const cls = isProf ? 'skill-prof' : '';
            const star = isProf ? ' ★' : '';
            skillsContainer.innerHTML += `<div class="skill-row"><span class="${cls}">${skill.name}${star}</span> <span class="${cls}">${fmtSign(total)}</span></div>`;
        });

        // --- Combat Stats ---
        let baseArmor = parseInt(document.getElementById('armorSelect').value); 
        let totalAc = baseArmor + 1; // +1 from Defense Fighting Style
        document.getElementById('ac-val').innerText = totalAc;

        // --- TOGGLE VISIBILITY LOGIC ---
    
        // 1. Fighting Spirit (Level 3+)
        const fsToggle = document.getElementById('fs-toggle-lbl');
        if (lvl >= 3) {
            fsToggle.style.display = 'flex';
        } else {
            fsToggle.style.display = 'none';
            document.getElementById('buffFighting').checked = false; // Uncheck if hidden
        }

        // 2. GWM (Level 14+) - Existing logic, just ensure it's here
        const gwmToggle = document.getElementById('gwm-toggle');
        if (lvl >= 14) {
            gwmToggle.style.display = 'flex';
        } else {
            gwmToggle.style.display = 'none';
            document.getElementById('buffGWM').checked = false;
        }

        // --- ATTACK MATH, GWM & FIGHTING SPIRIT ---
        const hitMod = mods.str + data.prof;
        const dmgMod = mods.str;

        // 1. Check Buff States
        const isGWM = document.getElementById('buffGWM')?.checked || false;
        const isFighting = document.getElementById('buffFighting')?.checked || false;

        // 2. Calculate Stats
        let meleeHit = hitMod;
        let meleeDmg = dmgMod;

        if (isGWM) {
            meleeHit -= 5;      // The penalty
            meleeDmg += 10; // The reward
        }
        
        // Create visual label for Advantage
        // We add a styled span so we can see it clearly
        const advHtml = isFighting ? ' <span style="color:#facc15; font-size:0.9em;">(ADV)</span>' : '';

        // 3. Update DOM Elements
        
        // NAGINATA
        const wep1HitEl = document.getElementById('wep1-hit');
        wep1HitEl.innerHTML = fmtSign(meleeHit) + " Hit" + advHtml;
        document.getElementById('wep1-dmg').innerText = `1d10${fmtSign(meleeDmg)}`;

        // POMMEL STRIKE
        const pamAttackCard = document.getElementById('pam-attack');
        if (lvl >= 6) {
            pamAttackCard.style.display = 'block';
            document.getElementById('pam-hit').innerHTML = fmtSign(meleeHit) + " Hit" + advHtml;
            document.getElementById('pam-dmg').innerText = `1d4${fmtSign(meleeDmg)}`;
        } else {
            pamAttackCard.style.display = 'none';
        }

        // LONGBOW (Dex based, No GWM, But gets Advantage)
        const rangedHit = mods.dex + data.prof;
        document.getElementById('wep3-hit').innerHTML = fmtSign(rangedHit) + " Hit" + advHtml;
        document.getElementById('wep3-dmg').innerText = `1d8${fmtSign(mods.dex)}`;

        // BREATH (Save based, No Attack Roll, No Advantage)
        const breathDC = 8 + data.prof + mods.con;
        document.getElementById('breath-dc').innerText = "DC " + breathDC;
        
        // Scale breath weapon damage
        let breathDice = "2d10";
        if (lvl >= 5) breathDice = "3d10";
        if (lvl >= 11) breathDice = "4d10";
        if (lvl >= 17) breathDice = "5d10";
        document.getElementById('breath-dmg').innerText = breathDice;

        // --- Features Render ---
        const featContainer = document.getElementById('features-container');
        featContainer.innerHTML = '';
        allFeatures.forEach(f => {
            let item = document.createElement('div');
            item.className = 'feature-item';
            item.innerHTML = `<span class="feat-name">${f.name} <span class="feat-source">${f.source}</span></span><div class="feat-desc">${f.desc}</div>`;
            featContainer.appendChild(item);
        });

        // --- Resources ---
        // Fighting Spirit Pips
        const fsPips = document.getElementById('fighting-spirit-pips');
        let fsPipHTML = '';
        for(let i=0; i<data.fightingSpirit; i++) {
            fsPipHTML += `<div class="resource-pip" onclick="useFightingSpirit(this)"></div>`;
        }
        fsPips.innerHTML = fsPipHTML;
        // Fix for Order of Operations on Temp HP
        document.getElementById('temp-hp-val').innerText = (lvl >= 15) ? "15" : (lvl >= 10) ? "10" : "5";

        // Action Surge Pips
        const asPips = document.getElementById('action-surge-pips');
        let asPipHTML = '';
        for(let i=0; i<data.actionSurge; i++) {
            asPipHTML += `<div class="resource-pip action-surge" onclick="this.classList.toggle('used')"></div>`;
        }
        asPips.innerHTML = asPipHTML;

        // Second Wind Pips
        const swPips = document.getElementById('second-wind-pips');
        let swPipHTML = '';
        for(let i=0; i<data.secondWind; i++) {
            swPipHTML += `<div class="resource-pip second-wind" onclick="useSecondWind(this)"></div>`;
        }
        swPips.innerHTML = swPipHTML;
        document.getElementById('second-wind-heal').innerText = `1d10+${lvl}`;

        // Breath Weapon Pip
        const breathPips = document.getElementById('breath-pips');
        breathPips.innerHTML = `<div class="resource-pip breath" onclick="this.classList.toggle('used')"></div>`;

        // Gem Flight (Level 5+)
        const gemFlightResource = document.getElementById('gem-flight-resource');
        if (data.gemFlight) {
            gemFlightResource.style.display = 'block';
            const gfPips = document.getElementById('gem-flight-pips');
            gfPips.innerHTML = `<div class="resource-pip breath" onclick="this.classList.toggle('used')"></div>`;
        } else {
            gemFlightResource.style.display = 'none';
        }

        // --- HP UPDATE LOGIC ---
        const maxHpEl = document.getElementById('max-hp');
        const curHpEl = document.getElementById('current-hp');
        
        // Get old values before updating
        const oldMax = parseInt(maxHpEl.innerText);
        const oldCur = parseInt(curHpEl.value);
        const damageTaken = oldMax - oldCur; // How much damage have you taken?

        // Update Max HP Text
        maxHpEl.innerText = data.hp;

        // Logic: Keep relative damage, but don't go below 0
        // If you were fully healed, you stay fully healed.
        // If you had 5 damage, you still have 5 damage at the new level.
        if (oldMax !== data.hp) {
            let newCur = data.hp - damageTaken;
            if (newCur < 0) newCur = 0;
            curHpEl.value = newCur;
        }

        // CRITICAL FIX: Force the visual bar to update now!
        updateHpBar();
    }

    // --- Short Rest Logic ---
    function shortRest() {
        // Reset Action Surge
        const asPips = document.querySelectorAll('#action-surge-pips .resource-pip');
        asPips.forEach(p => p.classList.remove('used'));

        // Reset Second Wind
        const swPips = document.querySelectorAll('#second-wind-pips .resource-pip');
        swPips.forEach(p => p.classList.remove('used'));

        // Heal Logic (Spend Hit Dice)
        const max = parseInt(document.getElementById('max-hp').innerText);
        const curInput = document.getElementById('current-hp');
        let current = parseInt(curInput.value);

        if(current < max) {
            // Roll a hit die (d10) + CON mod
            const conMod = getMod(parseInt(document.getElementById('con').innerText));
            const heal = Math.floor(Math.random() * 10) + 1 + conMod;
            curInput.value = Math.min(max, current + heal);
            logMsg(`Short Rest: Recovered Action Surge, Second Wind & healed ${heal} HP (1d10+${conMod}).`);
        } else {
            logMsg(`Short Rest: Recovered Action Surge & Second Wind.`);
        }
    }

    // --- Dice Roller Logic ---
    function rollAttack(name, hitId, dmgId) {
        const hitText = document.getElementById(hitId).innerText;
        // Clean the string to get just the number
        let hitMod = parseInt(hitText.replace(/[^0-9-]/g, '')); 
        let dmgText = document.getElementById(dmgId).innerText.split(' ')[0];

        // 1. CHECK BUFFS
        const hasFightingSpirit = document.getElementById('buffFighting').checked;
        // Safe check for GWM (in case element is hidden)
        const gwmEl = document.getElementById('buffGWM');
        const useGWM = gwmEl ? gwmEl.checked : false;

        // 2. APPLY GWM MATH (-5 Hit / +10 Dmg)
        let damageBonus = 0;
        if (useGWM) {
            hitMod -= 5;      // The penalty
            damageBonus = 10; // The reward
        }

        // 3. ROLL D20
        const d20 = Math.floor(Math.random() * 20) + 1;
        let hitTotal = d20 + hitMod;

        let isCrit = (d20 === 20);
        let isFail = (d20 === 1);

        // 4. ADVANTAGE LOGIC (Fighting Spirit)
        let advantageRoll = null;
        if (hasFightingSpirit && !isCrit && !isFail) {
            advantageRoll = Math.floor(Math.random() * 20) + 1;
            if (advantageRoll > d20) {
                hitTotal = advantageRoll + hitMod;
                isCrit = (advantageRoll === 20);
                isFail = (advantageRoll === 1);
            }
        }

        // 5. PARSE DAMAGE DICE
        const regex = /(\d+)d(\d+)([+-]\d+)?/;
        const match = dmgText.match(regex);

        if (match) {
            let count = parseInt(match[1]);
            let faces = parseInt(match[2]);
            // Existing weapon mod (e.g., +3 from STR)
            let mod = match[3] ? parseInt(match[3]) : 0; 

            if (isCrit) count *= 2;

            let rolls = [];
            for(let i=0; i<count; i++) {
                // Defense Fighting Style: No re-rolling 1s/2s (Great Weapon Fighting Style would go here if you had it)
                let r = Math.floor(Math.random() * faces) + 1;
                rolls.push(r);
            }
            
            // TOTAL DAMAGE: Dice + STR Mod + GWM Bonus
            let dmgTotal = rolls.reduce((a,b) => a+b, 0) + mod + damageBonus;

            // 6. FORMAT LOG
            let hitClass = isCrit ? 'log-crit' : (isFail ? 'log-fail' : '');
            let hitDisplay = isCrit ? 'NAT 20!' : (isFail ? 'MISS (1)' : hitTotal);
            
            let gwmTag = useGWM ? ' <span style="color:var(--warning); font-size:0.8em;">[GWM]</span>' : '';
            let advText = (advantageRoll !== null) ? ` (Adv: ${d20}/${advantageRoll})` : '';

            logMsg(`<strong>${name}:</strong> Attack <span class="${hitClass}">[${hitDisplay}]</span>${advText} | Dmg: <strong>${dmgTotal}</strong>${gwmTag} (${rolls.join('+')}${mod >=0 ? '+'+mod : mod}${useGWM ? '+10' : ''})`);
        } else {
            logMsg(`Error parsing damage: ${dmgText}`);
        }
    }

    function rollBreathWeapon() {
        const dc = document.getElementById('breath-dc').innerText;
        const dmgText = document.getElementById('breath-dmg').innerText;

        const regex = /(\d+)d(\d+)/;
        const match = dmgText.match(regex);

        if (match) {
            let count = parseInt(match[1]);
            let faces = parseInt(match[2]);

            let rolls = [];
            for(let i=0; i<count; i++) {
                rolls.push(Math.floor(Math.random() * faces) + 1);
            }
            let dmgTotal = rolls.reduce((a,b) => a+b, 0);

            logMsg(`<strong>Breath Weapon:</strong> ${dc} DEX Save | Dmg: <strong style="color:var(--magic)">${dmgTotal}</strong> Force (${rolls.join('+')})`);
        }
    }

    function logMsg(html) {
        const log = document.getElementById('combat-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `> ${html}`;
        log.prepend(entry);
    }

    // --- UI Logic ---
    function toggleModal(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    /* --- COMPANION SLIDER LOGIC --- */

    // 1. The Data (Based on your text + Monster Manual for Adult)
    const petStages = [
        {
            stage: "INFANT",
            age: "Up to 1 month",
            size: "Tiny",
            img: "images/hook_horror_infant.png",
            ac: "10",
            hp: "4 (1d4+2)",
            spd: "10 ft",
            // Stats: Weak physical, very low mental
            str: "9 (-1)", dex: "10 (+0)", con: "10 (+0)",
            int: "2 (-4)", wis: "6 (-2)", cha: "3 (-4)",
            attackHTML: `<span style="color:#94a3b8;">No effective attacks.</span>`
        },
        {
            stage: "YOUNG",
            age: "1–3 months",
            size: "Small",
            img: "images/hook_horror_young.png",
            ac: "11",
            hp: "11 (2d6+4)",
            spd: "15 ft",
            // Stats: Getting stronger
            str: "12 (+1)", dex: "10 (+0)", con: "12 (+1)",
            int: "3 (-4)", wis: "8 (-1)", cha: "4 (-3)",
            attackHTML: `<strong style="color:#fff">Hook:</strong> <span style="color:var(--success)">+3 Hit</span>, <span style="color:var(--samurai-highlight)">1d4+1</span> Piercing.`
        },
        {
            stage: "JUVENILE",
            age: "3–6 months",
            size: "Medium",
            img: "images/hook_horror_juvenile.png",
            ac: "13",
            hp: "39 (6d8+12)",
            spd: "20 ft",
            // Stats: Approaching adult levels
            str: "15 (+2)", dex: "10 (+0)", con: "14 (+2)",
            int: "5 (-3)", wis: "10 (+0)", cha: "6 (-2)",
            attackHTML: `<strong style="color:#fff">Hook:</strong> <span style="color:var(--success)">+4 Hit</span>, <span style="color:var(--samurai-highlight)">1d6+2</span> Piercing.`
        },
        {
            stage: "ADULT",
            age: "6+ months",
            size: "Large",
            img: "images/hook_horror_adult.png",
            ac: "15 (Natural)",
            hp: "75 (10d10+20)",
            spd: "30 ft, Climb 30 ft",
            // Stats: Full Stat Block
            str: "18 (+4)", dex: "10 (+0)", con: "15 (+2)",
            int: "6 (-2)", wis: "12 (+1)", cha: "7 (-2)",
            attackHTML: `
                <div style="text-align:left; margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid #334155;">
                    <div style="font-size:0.85em; color:#cbd5e1; margin-bottom:2px;">
                        <strong>Skills:</strong> Perception +3
                    </div>
                    <div style="font-size:0.85em; color:#cbd5e1; margin-bottom:2px;">
                        <strong>Senses:</strong> Blindsight 60ft (Blind beyond), Darkvision 120ft
                    </div>
                    <div style="font-size:0.8em; color:#94a3b8; font-style:italic;">
                        <strong>Traits:</strong> Echolocation (No blindsight if deafened), Keen Hearing (Adv. on hearing Perception).
                    </div>
                </div>
                <div style="text-align:left;">
                    <div style="margin-bottom:4px;"><strong style="color:#fff">Multiattack:</strong> Two hook attacks.</div>
                    <div>
                        <strong style="color:#fff">Hook:</strong> 
                        <span style="color:var(--success)">+6 Hit</span>, Reach 10ft.
                        <span style="color:var(--samurai-highlight)">11 (2d6+4)</span> Piercing.
                    </div>
                </div>`
        }
    ];

    let currentStageIdx = 0; // Default to Infant

    function setPetStage(index) {
        // Boundary checks
        if (index < 0) index = petStages.length - 1;
        if (index >= petStages.length) index = 0;
        
        currentStageIdx = index;
        const data = petStages[index];

        // Update Text & Stats
        document.getElementById('pet-stage-name').innerText = data.stage;
        document.getElementById('pet-size-age').innerText = `${data.size} Monstrosity (${data.age})`;
        document.getElementById('pet-ac').innerText = data.ac;
        document.getElementById('pet-hp').innerText = data.hp;
        document.getElementById('pet-spd').innerText = data.spd.split(',')[0]; // Shorten for the box
        document.getElementById('pet-str').innerText = data.str;
        document.getElementById('pet-dex').innerText = data.dex;
        document.getElementById('pet-con').innerText = data.con;
        document.getElementById('pet-int').innerText = data.int;
        document.getElementById('pet-wis').innerText = data.wis;
        document.getElementById('pet-cha').innerText = data.cha;
        document.getElementById('pet-attack-line').innerHTML = data.attackHTML;

        // Update Image
        // NOTE: If you don't have 4 images, you can comment this line out to keep one static image
        document.getElementById('pet-img').src = data.img;

        // Update Dots Active State
        const dots = document.querySelectorAll('.pet-dot');
        dots.forEach((d, i) => {
            if (i === index) d.classList.add('active');
            else d.classList.remove('active');
        });
    }

    function changePetStage(direction) {
        setPetStage(currentStageIdx + direction);
    }

    // 1. Image Error Fallback (Prevents broken images)
    document.addEventListener("DOMContentLoaded", function() {
        const images = document.querySelectorAll('img');
        images.forEach(img => {
            img.onerror = function() {
                // Replaces broken local image with a styled placeholder
                this.src = 'https://placehold.co/400x300/1c1917/d97706?text=Image+Missing'; 
            };
        });
        updateHpBar(); // Initialize bar
    });

    // 2. Dynamic Health Bar Logic
    function updateHpBar() {
        const curInput = document.getElementById('current-hp');
        const maxSpan = document.getElementById('max-hp');
        const greenBar = document.getElementById('hp-bar');
        const blueBar = document.getElementById('hp-bar-temp'); // This is now hardcoded!
        const thpBadge = document.getElementById('temp-hp-display');

        let cur = parseInt(curInput.value);
        let max = parseInt(maxSpan.innerText);
        
        // Get Temp HP value (remove the "+" sign if present)
        let thp = 0;
        if (thpBadge && thpBadge.style.display !== 'none') {
            thp = parseInt(thpBadge.innerText.replace('+', '')) || 0;
        }

        // Bounds check
        if (cur > max) {
            cur = max;
            curInput.value = max;
        }
        if (cur < 0) cur = 0;

        // 1. Update Green Bar
        const greenPct = (cur / max) * 100;
        greenBar.style.width = greenPct + "%";
        
        // Color Logic for Green Bar
        greenBar.className = 'hp-fill'; 
        if (greenPct < 50) greenBar.classList.add('warning');
        if (greenPct < 20) greenBar.classList.add('danger');

        // 2. Update Blue Temp HP Bar
        if (blueBar) {
            if (thp > 0) {
                const tempPct = (thp / max) * 100;
                
                // Position it at the end of the green bar
                blueBar.style.left = greenPct + "%"; 
                blueBar.style.width = tempPct + "%";
                blueBar.style.display = 'block';
            } else {
                blueBar.style.width = '0%';
                blueBar.style.display = 'none';
            }
        }
    }

    // 3. Automated Second Wind
    // Update your render function to include this onclick:
    // onclick="useSecondWind(this)" 
    function useSecondWind(element) {
        if (element.classList.contains('used')) return; // Already used
        
        element.classList.add('used');
        
        // Calculate Heal
        const lvl = parseInt(document.getElementById('levelRange').value);
        const healRoll = Math.floor(Math.random() * 10) + 1;
        const totalHeal = healRoll + lvl;
        
        // Apply Heal
        const curInput = document.getElementById('current-hp');
        const max = parseInt(document.getElementById('max-hp').innerText);
        let current = parseInt(curInput.value);
        
        curInput.value = Math.min(max, current + totalHeal);
        updateHpBar(); // Visual update
        
        logMsg(`<strong>Second Wind:</strong> Healed <span style="color:var(--success)">${totalHeal}</span> HP (1d10+${lvl}).`);
    }

    // 4. Automated Fighting Spirit Temp HP
    function useFightingSpirit(element) {
        if (element.classList.contains('used')) return; 
        
        // 1. Mark pip as used
        element.classList.add('used');
        
        // 2. Check the Fighting Spirit box
        const box = document.getElementById('buffFighting');
        if (box) {
            box.checked = true;
            updateDashboard(document.getElementById('levelRange').value);
            element.classList.add('used'); // Re-add class after dashboard refresh
        }
        
        // 3. Calculate Temp HP
        const lvl = parseInt(document.getElementById('levelRange').value);
        // Correct Order: check 15, then 10, then default
        let thp = (lvl >= 15) ? 15 : (lvl >= 10) ? 10 : 5;
        
        // 4. Show the Temp HP Badge
        const thpDisplay = document.getElementById('temp-hp-display');
        if (thpDisplay) {
            thpDisplay.innerText = "+" + thp;
            thpDisplay.style.display = 'block'; 
            
            // Animate badge
            thpDisplay.style.transform = "scale(1.5)";
            setTimeout(() => thpDisplay.style.transform = "scale(1)", 200);
        }
        
        logMsg(`<strong>Fighting Spirit:</strong> Gain Advantage & <span style="color:#3b82f6">+${thp} Temp HP</span>.`);
        
        // 5. IMPORTANT: Update the visual bars immediately!
        updateHpBar();
    }

    // 5. Long Rest Logic
    function longRest() {
        // Reset all pips
        document.querySelectorAll('.resource-pip').forEach(p => p.classList.remove('used'));
        
        // Heal to full
        const max = document.getElementById('max-hp').innerText;
        document.getElementById('current-hp').value = max;
        
        // Clear Temp HP
        const thpDisplay = document.getElementById('temp-hp-display');
        thpDisplay.style.display = 'none';
        thpDisplay.innerText = "0";

        updateHpBar();
        
        logMsg(`<span style="color:var(--accent)">LONG REST:</span> HP restored. All abilities recharged.`);
    }

    // Initialize Pet on Load
    setPetStage(0);

    // Initialize
    updateDashboard(1);

</script>
</body>
</html>