<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paladdin - Noble Genies Dexadin</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #8b5cf6; /* Genie Purple */
            --gold: #38bdf8;   /* Paladin Blueish */
            --magic: #c084fc;
            --success: #4ade80;
            --warning: #f87171;
            --dex-highlight: #2dd4bf;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }

        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--dex-highlight);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-info h1 { margin: 0; font-size: 1.8em; color: var(--dex-highlight); text-transform: uppercase; letter-spacing: 2px; }
        .header-info h2 { margin: 5px 0 0; font-size: 1em; color: var(--text-muted); }
        .rules-badge { 
            display: inline-block;
            background: var(--accent); 
            color: #fff; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 0.8em;
            margin-left: 10px;
        }

        .level-control {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 50px;
        }

        input[type=range] { accent-color: var(--dex-highlight); width: 200px; cursor: pointer; }
        .level-badge {
            background: var(--dex-highlight);
            color: #000;
            font-weight: bold;
            font-size: 1.5em;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--dex-highlight);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px;
            max-width: 1500px;
            margin: 0 auto;
        }

        @media (max-width: 1100px) { .dashboard { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #334155;
        }

        .card-title {
            color: var(--dex-highlight);
            font-weight: bold;
            text-transform: uppercase;
            border-bottom: 1px solid #475569;
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- IMAGES --- */
        .char-img-container {
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 2px solid var(--accent);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            background: #000;
        }
        .char-img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures the image fills the box without distortion */
            object-position: top center;
        }

        .steed-img-container {
            width: 100%;
            height: 150px;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--accent);
        }
        .steed-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- ROLEPLAY TEXT --- */
        .rp-block { margin-bottom: 12px; font-size: 0.85em; color: #cbd5e1; line-height: 1.4; }
        .rp-label { color: var(--gold); font-weight: bold; display: block; margin-bottom: 2px; font-size: 0.9em; text-transform: uppercase; }
        .rp-text { font-style: italic; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box {
            background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 8px; text-align: center;
        }
        .stat-label { font-size: 0.75em; color: var(--text-muted); display: block; }
        .stat-val { font-size: 1.2em; font-weight: bold; display: block; }
        .stat-mod { font-size: 0.9em; color: var(--dex-highlight); }

        .skill-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.85em;
            border-bottom: 1px solid #334155;
        }
        .skill-prof { color: var(--dex-highlight); font-weight: bold; }

        .combat-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .combat-stat {
            background: #0f172a; width: 23%; text-align: center; padding: 10px 0;
            border-radius: 8px; border: 1px solid #334155;
        }
        .c-val { display: block; font-size: 1.4em; font-weight: bold; color: var(--dex-highlight); }
        .c-lbl { font-size: 0.7em; text-transform: uppercase; color: #888; }

        .attack-card { background: #334155; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--accent); }
        .attack-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        .attack-detail { font-size: 0.85em; color: #cbd5e1; font-style: italic; }
        .dmg-text { color: var(--dex-highlight); }

        .feature-list { max-height: 450px; overflow-y: auto; padding-right: 5px; }
        .feature-item { margin-bottom: 12px; border-bottom: 1px solid #475569; padding-bottom: 8px; }
        .feat-name { color: var(--dex-highlight); font-weight: bold; display: block; margin-bottom: 3px; }
        .feat-source { font-size: 0.75em; color: #94a3b8; background: #0f172a; padding: 2px 6px; border-radius: 4px; }
        .feat-desc { font-size: 0.85em; line-height: 1.4; color: #cbd5e1; margin-top: 5px; }
        
        .kw-action { color: #f472b6; font-weight: bold; }
        .kw-bonus { color: #fbbf24; font-weight: bold; }
        .kw-react { color: #60a5fa; font-weight: bold; }

        /* PIPS (Slots & CD) */
        .slot-display { margin-bottom: 15px; }
        .slot-row { display: flex; align-items: center; margin-bottom: 5px; }
        .slot-lvl { width: 40px; font-weight: bold; color: var(--magic); }
        .slot-pip { 
            width: 12px; height: 12px; border-radius: 50%; background: var(--magic); 
            margin-right: 5px; box-shadow: 0 0 5px var(--magic); 
            cursor: pointer;
        }
        .slot-pip.used { 
            background: #334155; 
            box-shadow: none; 
            border: 1px solid #475569; 
        }
        /* Channel Divinity Pips (White) */
        .cd-pip {
            width: 14px; height: 14px; border-radius: 50%; background: #fff;
            margin-right: 6px; box-shadow: 0 0 8px #fff; cursor: pointer; display: inline-block;
        }
        .cd-pip.used {
            background: #334155; box-shadow: none; border: 1px solid #475569;
        }

        .spell-category { font-size: 0.8em; text-transform: uppercase; color: #94a3b8; margin: 15px 0 5px; border-bottom: 1px solid #475569; }
        
        /* --- Spell Items --- */
        .spell-item { 
            display: flex; justify-content: space-between; padding: 5px; 
            background: #0f172a; margin-bottom: 3px; border-radius: 4px; 
            border-left: 3px solid #64748b; font-size: 0.9em; position: relative; cursor: help;
        }

        /* Highlight Logic */
        .spell-item.paladin { 
            border-left-color: var(--dex-highlight); 
            background: rgba(45, 212, 191, 0.2) !important; 
            border-bottom: 1px solid rgba(45, 212, 191, 0.1);
        }
        .spell-item.genie { border-left-color: var(--accent); background: #0f172a; }
        .spell-item.always { border-left-color: var(--success); background: #0f172a; }
        .spell-item.cantrip { border-left-color: #fff; background: #0f172a; }

        .spell-name { font-weight: bold; }
        .spell-meta { font-size: 0.8em; color: #94a3b8; }
        .spell-usage { font-size: 0.85em; background: rgba(0, 0, 0, 0.4); border: 1px solid var(--text-muted); color: #fff; padding: 1px 8px; border-radius: 12px; font-weight: bold; display: inline-block; }
        .spell-note { display:block; font-size:0.75em; color:#94a3b8; margin-top:2px; font-style:italic;}

        /* Tooltips */
        .spell-tooltip {
            visibility: hidden; width: 240px; background-color: #0f172a; color: #cbd5e1;
            text-align: left; border-radius: 6px; padding: 12px; position: absolute; z-index: 100;
            bottom: 110%; left: 50%; margin-left: -120px; box-shadow: 0 4px 15px rgba(0,0,0,0.9);
            border: 1px solid var(--dex-highlight); font-size: 0.85em; line-height: 1.4;
            opacity: 0; transition: opacity 0.2s; pointer-events: none; white-space: normal;
        }
        .spell-tooltip::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: var(--dex-highlight) transparent transparent transparent;
        }
        .spell-item:hover .spell-tooltip { visibility: visible; opacity: 1; }

        .rules-note { background: rgba(45, 212, 191, 0.1); border: 1px solid var(--dex-highlight); border-radius: 4px; padding: 8px; font-size: 0.85em; color: var(--dex-highlight); margin-top: 10px; }

        /* Steed Hover */
        .steed-tooltip {
            visibility: hidden; width: 300px; background-color: #0f172a; border: 2px solid var(--accent);
            border-radius: 8px; padding: 0; position: absolute; bottom: 110%; right: 0; z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,1); opacity: 0; transition: opacity 0.2s; pointer-events: none; text-align: left;
            overflow: hidden;
        }
        .steed-content { padding: 12px; }
        #steed-resource { position: relative; cursor: help; }
        #steed-resource:hover .steed-tooltip { visibility: visible; opacity: 1; }

        /* Stat Block inside Tooltip */
        .sb-header { border-bottom: 1px solid var(--accent); margin-bottom: 8px; padding-bottom: 5px; }
        .sb-title { color: #facc15; font-weight: bold; font-size: 1.1em; text-transform: uppercase; }
        .sb-meta { color: #94a3b8; font-size: 0.8em; font-style: italic; }
        .sb-stats { display: flex; justify-content: space-between; background: #1e293b; padding: 5px; border-radius: 4px; margin-bottom: 8px; }
        .sb-val { color: #fff; font-weight: bold; }
        .sb-lbl { color: #94a3b8; font-size: 0.75em; }
        .sb-action { font-size: 0.9em; margin-bottom: 6px; line-height: 1.3; color: #cbd5e1; }
        .sb-action strong { color: #facc15; }
        
        .toggle-container { display: flex; align-items: center; font-size: 0.8em; color: #ccc; margin-left: 10px; }
        .toggle-checkbox { margin-right: 5px; accent-color: var(--magic); }

        /* BUFF PANEL */
        .buff-panel { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
        .buff-lbl { 
            font-size: 0.75em; color: #94a3b8; background: #1e293b; padding: 4px 8px; 
            border-radius: 4px; border: 1px solid #334155; display: flex; align-items: center; cursor: pointer;
        }
        .buff-lbl:hover { border-color: var(--dex-highlight); color:#fff; }
        .buff-chk { margin-right: 5px; accent-color: var(--success); }

        /* --- NEW CSS SNIPPETS --- */

        /* Make attack cards look clickable */
        .attack-card { cursor: pointer; transition: transform 0.1s, border-color 0.1s; }
        .attack-card:active { transform: scale(0.98); }
        .attack-card:hover { border-color: #fff; }

        /* Back Button */
        .back-btn {
            background: #1e293b; border: 1px solid var(--accent);
            color: var(--accent); padding: 8px 16px; border-radius: 20px;
            font-weight: bold; cursor: pointer; text-decoration: none;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
        }
        .back-btn:hover { background: var(--accent); color: #fff; box-shadow: 0 0 10px var(--accent); }

        /* Short Rest Button */
        .rest-btn {
            background: #1e293b; border: 1px solid var(--dex-highlight);
            color: var(--dex-highlight); padding: 5px 15px; border-radius: 20px;
            font-weight: bold; cursor: pointer; margin-left: 15px;
            transition: all 0.2s;
        }
        .rest-btn:hover { background: var(--dex-highlight); color: #000; box-shadow: 0 0 10px var(--dex-highlight); }

        /* Combat Log Console */
        #combat-log {
            background: #000; color: #4ade80; font-family: 'Consolas', monospace;
            font-size: 0.85em; padding: 10px; border-radius: 6px; border: 1px solid #334155;
            height: 120px; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column-reverse;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-crit { color: #facc15; font-weight: bold; text-shadow: 0 0 5px #facc15; }
        .log-fail { color: #f87171; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="back-btn">← Back</a>
    <div class="header-info">
        <h1>Paiman "Paladdin" Aladdin <span class="rules-badge">Dexadin</span></h1>
        <h2>Oath of Noble Genies • Human Merchant • <span style="color:var(--dex-highlight)">Elemental Duelist</span></h2>
    </div>
    <div class="level-control">
        <label>LEVEL</label>
        <input type="range" id="levelRange" min="1" max="8" value="1" oninput="updateDashboard(this.value)">
        <div class="level-badge" id="lvl-badge">1</div>
        <button class="rest-btn" onclick="shortRest()">SHORT REST</button>
    </div>
</header>

<div class="dashboard">

    <div class="col-1">
        <div class="card">
            <div class="card-title">Identity</div>
            
            <div class="char-img-container">
                <img src="images/paladdin.png" alt="Paiman Aladdin" class="char-img">
            </div>

            <div class="rp-block">
                <span class="rp-label">Physical</span>
                <span class="rp-text">Mixed Chinese/Persian descent. Wears reinforced silk robes of Tyrian purple. No metal armor. Carries a "Bandolier of Essences" as a focus. Smell of ozone and sandalwood.</span>
            </div>
            <div class="rp-block">
                <span class="rp-label">Personality</span>
                <span class="rp-text">"The Nose Knows." Experiences the world through scent. Aggressively sophisticated; refuses trail rations. Refers to himself as "The Paladdin."</span>
            </div>
            <div class="rp-block">
                <span class="rp-label">Ideals (Lawful/Good)</span>
                <span class="rp-text"><strong>Refinement & Synthesis:</strong> The world is raw; I must distill it into something pure. Strength comes from mixing cultures.</span>
            </div>
            <div class="rp-block">
                <span class="rp-label">Bonds</span>
                <span class="rp-text">Seek the ingredients for the "Breath of Heaven" to restore my family fortune. My Steed is the spirit of my grandfather's prize bird.</span>
            </div>
            <div class="rp-block" style="margin-bottom:0;">
                <span class="rp-label">Flaws</span>
                <span class="rp-text" style="color:var(--warning)">Sensory Overload (Bad smells). Materialistic. Combat Vanity (Must look good fighting).</span>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                Attributes
                <div class="toggle-container">
                    <input type="checkbox" id="amuletToggle" class="toggle-checkbox" onchange="updateDashboard(document.getElementById('levelRange').value)" checked>
                    <label for="amuletToggle">Amulet (+1 DC/CD)</label>
                </div>
            </div>
            <div class="stat-grid">
                <div class="stat-box"><span class="stat-label">STR</span><span class="stat-val" id="str">8</span><span class="stat-mod" id="str-mod">-1</span></div>
                <div class="stat-box" style="border-color:var(--dex-highlight)"><span class="stat-label" style="color:var(--dex-highlight)">DEX</span><span class="stat-val" id="dex">17</span><span class="stat-mod" id="dex-mod">+3</span></div>
                <div class="stat-box"><span class="stat-label">CON</span><span class="stat-val" id="con">14</span><span class="stat-mod" id="con-mod">+2</span></div>
                <div class="stat-box"><span class="stat-label">INT</span><span class="stat-val" id="int">10</span><span class="stat-mod" id="int-mod">+0</span></div>
                <div class="stat-box"><span class="stat-label">WIS</span><span class="stat-val" id="wis">12</span><span class="stat-mod" id="wis-mod">+1</span></div>
                <div class="stat-box" style="border-color:var(--accent)"><span class="stat-label" style="color:var(--accent)">CHA</span><span class="stat-val" id="cha">16</span><span class="stat-mod" id="cha-mod">+3</span></div>
            </div>
            <div style="text-align:center; font-size:0.9em; color:#888;">
                Proficiency: <strong style="color:var(--text-main)" id="prof-bonus">+2</strong>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Saving Throws <span style="font-size:0.7em; font-weight:normal;">(Aura at 6+)</span></div>
            <div id="saves-container"></div>
        </div>

        <div class="card">
            <div class="card-title">Skills</div>
            <div id="skills-container"></div>
            <div style="font-size:0.75em; color:#888; margin-top:8px;">
                ★ = Proficient
            </div>
        </div>
    </div>

    <div class="col-2">
        <div class="card" style="padding:10px; background:#0f172a;">
            <div class="card-title" style="margin:0 0 5px 0; border:none; font-size:0.8em;">Combat Log</div>
            <div id="combat-log">
                <div class="log-entry">> System Ready...</div>
            </div>
        </div>
        <div class="card">
            <div class="combat-bar">
                <div class="combat-stat"><span class="c-lbl">AC</span><span class="c-val" id="ac-val">15</span></div>
                <div class="combat-stat">
                    <span class="c-lbl">HP</span>
                    <div style="display:flex; align-items:center; justify-content:center;">
                        <input type="number" id="current-hp" value="12" style="width:40px; background:transparent; border:none; color:var(--dex-highlight); font-weight:bold; font-size:1.4em; text-align:right; padding:0;">
                        <span style="font-size:1em; color:#888; margin-left:2px;">/<span id="max-hp">12</span></span>
                    </div>
                </div>
                <div class="combat-stat"><span class="c-lbl">Init</span><span class="c-val" id="init-val">+5</span></div>
                <div class="combat-stat"><span class="c-lbl">Speed</span><span class="c-val">9m</span></div>
            </div>
            
            <div class="card-title">Action Economy (Nick Mastery)</div>
            
            <div class="buff-panel">
                <label class="buff-lbl"><input type="checkbox" id="buffBless" class="buff-chk" onchange="updateDashboard(document.getElementById('levelRange').value)"> Bless (+1d4 Hit/Save)</label>
                <label class="buff-lbl"><input type="checkbox" id="buffDivine" class="buff-chk" onchange="updateDashboard(document.getElementById('levelRange').value)"> Divine Favor (+1d4 Dmg)</label>
            </div>

            <div class="attack-card" onclick="rollAttack('Scimitar', 'wep1-hit', 'wep1-dmg')">
                <div class="attack-header">
                    <span>SCIMITAR <span style="font-size:0.8em; color:#888;">(Light, Nick)</span></span>
                    <span id="wep1-hit" style="color:var(--success);">+5 Hit</span>
                </div>
                <div class="attack-detail">
                    Damage: <span class="dmg-text" id="wep1-dmg">1d6+3</span> Slashing<br>
                    <span class="kw-action">Mastery (Nick):</span> Extra light attack is part of Action.
                </div>
            </div>

            <div class="attack-card" onclick="rollAttack('Shortsword', 'wep2-hit', 'wep2-dmg')">
                <div class="attack-header">
                    <span>SHORTSWORD <span style="font-size:0.8em; color:#888;">(Light, Vex)</span></span>
                    <span id="wep2-hit" style="color:var(--success);">+5 Hit</span>
                </div>
                <div class="attack-detail">
                    Damage: <span class="dmg-text" id="wep2-dmg">1d6</span> Piercing <span id="twf-mod" style="font-size:0.8em; color:var(--dex-highlight); display:none;">(+DEX)</span><br>
                    <span class="kw-action">Mastery (Vex):</span> Hit grants Advantage.
                </div>
            </div>

            <div class="attack-card" style="border-left-color: var(--magic);" onclick="rollAttack('Chromatic Orb', 'spell-hit', 'corb-dmg')">
                <div class="attack-header">
                    <span>CHROMATIC ORB <span style="font-size:0.8em; color:#888;">(Genie, 27m)</span></span>
                    <span id="spell-hit" style="color:var(--magic);">+5 Hit</span>
                </div>
                <div class="attack-detail">
                    Damage: <span class="dmg-text" id="corb-dmg" style="color:var(--magic)">3d8</span> (Acid/Cold/Fire/Lightning/Poison/Thunder)
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Active Features & Feats</div>
            <div class="feature-list" id="features-container">
            </div>
        </div>
    </div>

    <div class="col-3">
        <div class="card">
            <div class="card-title">Spellcasting</div>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div style="text-align:center;">
                    <span style="display:block; font-size:1.2em; font-weight:bold; color:var(--magic);" id="spell-dc">13</span>
                    <span style="font-size:0.7em;">Save DC</span>
                </div>
                <div style="text-align:center;">
                    <span style="display:block; font-size:1.2em; font-weight:bold; color:var(--magic);" id="spell-atk">+5</span>
                    <span style="font-size:0.7em;">Attack Mod</span>
                </div>
                <div style="text-align:center;">
                    <span style="display:block; font-size:1.2em; font-weight:bold; color:var(--text-main);"><span id="prep-count">2</span> / <span id="prep-limit">2</span></span>
                    <span style="font-size:0.7em;">Prepared</span>
                </div>
            </div>

            <div class="slot-display" id="slot-container"></div>

            <div class="card-title" style="border:none; margin-top:15px;">Spellbook</div>
            <div id="spells-list"></div>
        </div>
        
        <div class="card">
            <div class="card-title">Resources</div>
            <div class="attack-card" style="border-left-color: var(--gold);">
                <div class="attack-header"><span>Lay on Hands</span> <span><span id="loh-val">5</span> HP Pool</span></div>
                <div class="attack-detail"><span class="kw-bonus">Bonus Action</span>. 5 HP removes Poisoned.</div>
            </div>
            
            <div class="attack-card" style="border-left-color: #fff; display:none;" id="cd-resource"></div>
            
            <div class="attack-card" style="border-left-color: var(--success);" id="smite-resource">
                <div class="attack-header"><span>Free Divine Smite</span> <span>1 / LR</span></div>
                <div class="attack-detail"><span class="kw-bonus">Bonus Action</span> after hit. 2d8 Radiant. Once/turn.</div>
            </div>
            <div class="attack-card" style="border-left-color: var(--magic);" id="shield-resource">
                <div class="attack-header"><span>Shield (Magic Initiate)</span> <span>1 / LR</span></div>
                <div class="attack-detail"><span class="kw-react">Reaction</span>. +5 AC until start of next turn.</div>
            </div>
            
            <div class="attack-card" style="border-left-color: var(--accent);" id="steed-resource">
                <div class="attack-header"><span>Find Steed (Free)</span> <span>1 / LR</span></div>
                <div class="attack-detail">Summon Golden Stormstrider.</div>
                
                <div class="steed-tooltip">
                    <div class="steed-img-container">
                         <img src="images/ostrich.png" alt="Golden Ostrich" class="steed-img">
                    </div>
                    
                    <div class="steed-content">
                        <div class="sb-header">
                            <div class="sb-title">Golden Stormstrider</div>
                            <div class="sb-meta">Large Fey (Yellow Ostrich)</div>
                        </div>
                        <div class="sb-stats">
                            <div style="text-align:center"><span class="sb-lbl">AC</span><br><span class="sb-val" id="sb-ac">15</span></div>
                            <div style="text-align:center"><span class="sb-lbl">HP</span><br><span class="sb-val" id="sb-hp">25</span></div>
                            <div style="text-align:center"><span class="sb-lbl">SPD</span><br><span class="sb-val">18m</span></div>
                        </div>
                        <div class="sb-action">
                            <strong>Kweh Kick:</strong> <span id="sb-atk">+5</span> Hit, <span id="sb-dmg">1d8+5</span> Bludgeoning.
                        </div>
                        <div class="sb-action">
                            <strong>Fey Step (BA):</strong> Teleport 18m to unoccupied space.
                        </div>
                        <div class="sb-action" style="font-style:italic; font-size:0.8em; color:#94a3b8; margin-top:5px;">
                            *Shared Spells: Spells targeting only you also target the steed.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- DATA ---
    const spellSlotsByLevel = {
        1: [2, 0, 0], 2: [2, 0, 0], 3: [3, 0, 0], 4: [3, 0, 0], 
        5: [4, 2, 0], 6: [4, 2, 0], 7: [4, 3, 0], 8: [4, 3, 0]
    };
    const preparedSpellsByLevel = { 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 6, 7: 7, 8: 7 };

    const magicInitiateSpells = [
        {name: "Fire Bolt", level: 0, school: "Evoc", note: "36m, 1d10 Fire", desc: "Ranged spell attack. 1d10 Fire damage. (Alchemy Vial)", upcast: "Damage increases to 2d10 (5th), 3d10 (11th), 4d10 (17th).",
         roll: {type: "attack", dice: "1d10", dmgType: "Fire"}},
        {name: "Minor Illusion", level: 0, school: "Illu", note: "Utility", desc: "Create a sound or image of an object (1 min).", upcast: null,
         roll: {type: "info", desc: "Created an illusion (12m range)."}},
        {name: "Shield", level: 1, school: "Abjur", note: "+5 AC Reaction", desc: "Reaction when hit. +5 AC until next turn. Magic Missile immunity. (Crystal Barrier)", upcast: null,
         roll: {type: "buff", desc: "Shield! +5 AC until next turn."}}
    ];

    const genieSpellsByLevel = {
        3: [
            {name: "Chromatic Orb", level: 1, desc: "3d8 damage (Acid/Cold/Fire/Light/Poison/Thunder). Attack roll. Range 27m.", note: "Ranged 27m", upcast: "+1d8 damage per slot level.",
             roll: {type: "attack", dice: "3d8", dmgType: "Elemental"}},
            {name: "Elementalism", level: 0, desc: "Create harmless elemental effects (breeze, light, spray, dust).", note: "Utility", upcast: null,
             roll: {type: "info", desc: "Created elemental effect."}},
            {name: "Thunderous Smite", level: 1, desc: "Bonus Action. Hit deals +2d6 Thunder. Str save or push 3m + Prone.", note: "2d6 Thunder + Push", upcast: null,
             roll: {type: "buff", desc: "Active: Next hit deals +2d6 Thunder + STR Save or Push 3m."}}
        ],
        5: [
            {name: "Mirror Image", level: 2, desc: "Create 3 duplicates. Roll d20 to redirect attack to duplicate.", note: "Defense", upcast: null,
             roll: {type: "buff", desc: "3 duplicates active. Attacks may target duplicates."}},
            {name: "Phantasmal Force", level: 2, desc: "Illusion in mind (INT Save). 1d6 Psychic/turn.", note: "INT save", upcast: null,
             roll: {type: "save", save: "INT", desc: "1d6 Psychic/turn if target fails."}}
        ],
        9: [
            {name: "Fly", level: 3, desc: "Target gains 18m fly speed.", note: "Concentration", upcast: "Target +1 creature per slot level.",
             roll: {type: "buff", desc: "Target gains 18m fly speed (Concentration)."}},
            {name: "Gaseous Form", level: 3, desc: "Turn willing creature into mist. Resist nonmagical dmg.", note: "Escape", upcast: null,
             roll: {type: "buff", desc: "Target is now mist. Resist nonmagical damage."}}
        ]
    };

    const allSkills = [
        {name: "Acrobatics", ability: "dex"}, {name: "Animal Handling", ability: "wis"}, {name: "Arcana", ability: "int"},
        {name: "Athletics", ability: "str"}, {name: "Deception", ability: "cha"}, {name: "History", ability: "int"},
        {name: "Insight", ability: "wis"}, {name: "Intimidation", ability: "cha"}, {name: "Investigation", ability: "int"},
        {name: "Medicine", ability: "wis"}, {name: "Nature", ability: "int"}, {name: "Perception", ability: "wis"},
        {name: "Performance", ability: "cha"}, {name: "Persuasion", ability: "cha"}, {name: "Religion", ability: "int"},
        {name: "Sleight of Hand", ability: "dex"}, {name: "Stealth", ability: "dex"}, {name: "Survival", ability: "wis"}
    ];
    const proficientSkills = {
        1: ["Intimidation", "Persuasion", "Perception", "Stealth", "Athletics"],
        3: ["Intimidation", "Persuasion", "Perception", "Stealth", "Athletics", "Acrobatics"]
    };

    const levels = {
        1: {
            str: 8, dex: 17, con: 14, int: 10, wis: 12, cha: 16, prof: 2, hp: 12,
            features: [
                {name: "Human: Resourceful", source: "Species", desc: "Gain Heroic Inspiration on Long Rest."},
                {name: "Human: Skillful", source: "Species", desc: "Gain one extra skill proficiency (Athletics)."},
                {name: "Human: Versatile (Magic Initiate)", source: "Species", desc: "Fire Bolt, Minor Illusion + Shield 1/LR (CHA-based)."},
                {name: "Background: Alert", source: "Merchant", desc: "Add Proficiency Bonus to Initiative. Can swap Initiative with willing ally."},
                {name: "Lay on Hands", source: "Paladin 1", desc: "<span class='kw-bonus'>Bonus Action</span> to heal. 5 HP removes Poisoned."},
                {name: "Weapon Mastery (2)", source: "Paladin 1", desc: "<b>Scimitar (Nick):</b> Light attack is part of Attack action.<br><b>Shortsword (Vex):</b> Advantage on next attack."},
                {name: "Spellcasting", source: "Paladin 1", desc: "Prepare Paladin spells. CHA is spellcasting ability."}
            ],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "Bonus Action. Weapon attacks deal +1d4 Radiant.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Heroism", level: 1, school: "Conc", desc: "Immunity to Frightened. Gain Temp HP each turn.", upcast: "Target one additional creature for each slot level above 1st.",
                 roll: {type: "buff", desc: "Target immune to Frightened + gains Temp HP."}}
            ]
        },
        2: {
            str: 8, dex: 17, con: 14, int: 10, wis: 12, cha: 16, prof: 2, hp: 20,
            features: [
                {name: "Fighting Style: Two-Weapon Fighting", source: "Paladin 2", desc: "Add ability modifier to damage of Light property extra attack."},
                {name: "Paladin's Smite", source: "Paladin 2", desc: "<span class='kw-bonus'>Bonus Action</span> after hit: 2d8 Radiant. 1 free cast/LR."}
            ],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "Bonus Action. +1d4 Radiant.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Heroism", level: 1, school: "Conc", desc: "Immune Frightened + Temp HP.", upcast: "Target one additional creature for each slot level above 1st.",
                 roll: {type: "buff", desc: "Target immune to Frightened + gains Temp HP."}},
                {name: "Shield of Faith", level: 1, school: "Conc", desc: "+2 AC to one creature.", upcast: null,
                 roll: {type: "buff", desc: "Target gains +2 AC."}}
            ]
        },
        3: {
            str: 8, dex: 17, con: 14, int: 10, wis: 12, cha: 16, prof: 2, hp: 28,
            features: [
                {name: "Channel Divinity (2/rest)", source: "Paladin 3", desc: "Shared Pool: <b>Divine Sense</b> (BA) or <b>Elemental Smite</b>."},
                {name: "Elemental Smite", source: "Noble Genies 3", desc: "After Divine Smite, expend CD for effect. <b>Dao:</b> Restrained (STR Save)."},
                {name: "Genie's Splendor", source: "Noble Genies 3", desc: "AC = 10 + DEX + CHA. Works with Shield! Gain skill: Acrobatics."}
            ],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "Bonus Action. +1d4 Radiant.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Shield of Faith", level: 1, school: "Conc", desc: "+2 AC.", upcast: null,
                 roll: {type: "buff", desc: "Target gains +2 AC."}},
                {name: "Command", level: 1, school: "Ench", desc: "WIS save or obey one-word command.", upcast: "Target one additional creature for each slot level above 1st.",
                 roll: {type: "save", save: "WIS", desc: "Halt, Drop, or Flee."}},
                {name: "Cure Wounds", level: 1, school: "Evoc", desc: "Heal 2d8 + CHA Mod.", upcast: "Heal increases by 1d8 for each slot level above 1st.",
                 roll: {type: "heal", dice: "2d8+MOD"}}
            ]
        },
        4: {
            str: 8, dex: 18, con: 14, int: 10, wis: 12, cha: 17, prof: 2, hp: 36,
            features: [
                {name: "Feat: Defensive Duelist", source: "Paladin 4", desc: "+1 DEX. <span class='kw-react'>Reaction</span> to add Prof to AC against one attack."}
            ],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "Bonus Action. +1d4 Radiant.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Shield of Faith", level: 1, school: "Conc", desc: "+2 AC.", upcast: null,
                 roll: {type: "buff", desc: "Target gains +2 AC."}},
                {name: "Command", level: 1, school: "Ench", desc: "WIS save or obey command.", upcast: "Target one additional creature for each slot level above 1st.",
                 roll: {type: "save", save: "WIS", desc: "Halt, Drop, or Flee."}},
                {name: "Cure Wounds", level: 1, school: "Evoc", desc: "Heal 2d8 + Mod.", upcast: "+1d8 healing per level.",
                 roll: {type: "heal", dice: "2d8+MOD"}},
                {name: "Wrathful Smite", level: 1, school: "Conc", desc: "Bonus Action. +1d6 Psychic + Frightened.", upcast: null,
                 roll: {type: "buff", desc: "Next hit: +1d6 Psychic + WIS Save or Frightened."}}
            ]
        },
        5: {
            str: 8, dex: 18, con: 14, int: 10, wis: 12, cha: 17, prof: 3, hp: 44,
            features: [
                {name: "Extra Attack", source: "Paladin 5", desc: "Attack twice with Action. Total 3 attacks with Nick."},
                {name: "Faithful Steed", source: "Paladin 5", desc: "Find Steed always prepared + 1 free cast/LR."},
                {name: "Defensive Duelist Upgrade", source: "Feat", desc: "Reaction AC bonus is now +3 (Prof Bonus)."}
            ],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "+1d4 Radiant on hits.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Shield of Faith", level: 1, school: "Conc", desc: "+2 AC.", upcast: null,
                 roll: {type: "buff", desc: "Target gains +2 AC."}},
                {name: "Aid", level: 2, school: "Abjur", desc: "Increase Max HP of 3 creatures by 5 (8 hours).", upcast: "HP increases by 5 for each slot level above 2nd.",
                 roll: {type: "buff", desc: "3 creatures gain +5 Max HP for 8 hours."}},
                {name: "Magic Weapon", level: 2, school: "Conc", desc: "Weapon becomes +1.", upcast: "Becomes +2 at 4th level, +3 at 6th level.",
                 roll: {type: "buff", desc: "Weapon is now +1 (magic)."}},
                {name: "Lesser Restoration", level: 2, school: "Abjur", desc: "Cure condition (Blind/Deaf/Paralyze/Poison).", upcast: null,
                 roll: {type: "buff", desc: "Removed a condition from target."}},
                {name: "Misty Step", level: 2, school: "Conj", desc: "BA Teleport 9m.", upcast: null,
                 roll: {type: "info", desc: "Teleported 9m!"}}
            ]
        },
        6: {
            str: 8, dex: 18, con: 14, int: 10, wis: 12, cha: 17, prof: 3, hp: 52,
            features: [
                {name: "Aura of Protection (3m)", source: "Paladin 6", desc: "Add CHA mod to all saves for you and allies within 3m."}
            ],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "+1d4 Radiant on hits.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Shield of Faith", level: 1, school: "Conc", desc: "+2 AC.", upcast: null,
                 roll: {type: "buff", desc: "Target gains +2 AC."}},
                {name: "Aid", level: 2, school: "Abjur", desc: "+5 Max HP.", upcast: "+5 HP per level.",
                 roll: {type: "buff", desc: "3 creatures gain +5 Max HP for 8 hours."}},
                {name: "Magic Weapon", level: 2, school: "Conc", desc: "Weapon becomes +1.", upcast: "+2 at 4th, +3 at 6th.",
                 roll: {type: "buff", desc: "Weapon is now +1 (magic)."}},
                {name: "Lesser Restoration", level: 2, school: "Abjur", desc: "Cure condition.", upcast: null,
                 roll: {type: "buff", desc: "Removed a condition from target."}},
                {name: "Warding Bond", level: 2, school: "Abjur", desc: "Share damage with ally +1 AC/Save.", upcast: null,
                 roll: {type: "buff", desc: "Bonded to ally: +1 AC/Save, share damage."}}
            ]
        },
        7: {
            str: 8, dex: 18, con: 14, int: 10, wis: 12, cha: 17, prof: 3, hp: 60,
            features: [{name: "Aura of Elemental Shielding", source: "Noble Genies 7", desc: "Resistance to chosen element for Aura allies."}],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "+1d4 Radiant.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Shield of Faith", level: 1, school: "Conc", desc: "+2 AC.", upcast: null,
                 roll: {type: "buff", desc: "Target gains +2 AC."}},
                {name: "Aid", level: 2, school: "Abjur", desc: "+5 Max HP.", upcast: "+5 HP per level.",
                 roll: {type: "buff", desc: "3 creatures gain +5 Max HP for 8 hours."}},
                {name: "Magic Weapon", level: 2, school: "Conc", desc: "Weapon +1.", upcast: "+2 at 4th, +3 at 6th.",
                 roll: {type: "buff", desc: "Weapon is now +1 (magic)."}},
                {name: "Warding Bond", level: 2, school: "Abjur", desc: "Share damage.", upcast: null,
                 roll: {type: "buff", desc: "Bonded to ally: +1 AC/Save, share damage."}},
                {name: "Zone of Truth", level: 2, school: "Ench", desc: "4.5m Sphere. No lies allowed (CHA Save).", upcast: null,
                 roll: {type: "save", save: "CHA", desc: "4.5m sphere where no lies can be spoken."}},
                {name: "Shining Smite", level: 2, school: "Conc", desc: "+2d6 Radiant + Advantage on target.", upcast: "+1d6 damage for each slot level above 2nd.",
                 roll: {type: "buff", desc: "Next hit: +2d6 Radiant + Advantage on target."}}
            ]
        },
        8: {
            str: 8, dex: 20, con: 14, int: 10, wis: 12, cha: 17, prof: 3, hp: 68,
            features: [{name: "ASI: Dexterity +2", source: "Paladin 8", desc: "DEX capped at 20. AC = 18."}],
            prepared: [
                {name: "Divine Favor", level: 1, school: "Conc", desc: "+1d4 Radiant.", upcast: null,
                 roll: {type: "buff", desc: "Active: Add +1d4 Radiant to weapon hits."}},
                {name: "Shield of Faith", level: 1, school: "Conc", desc: "+2 AC.", upcast: null,
                 roll: {type: "buff", desc: "Target gains +2 AC."}},
                {name: "Aid", level: 2, school: "Abjur", desc: "+5 Max HP.", upcast: "+5 HP per level.",
                 roll: {type: "buff", desc: "3 creatures gain +5 Max HP for 8 hours."}},
                {name: "Magic Weapon", level: 2, school: "Conc", desc: "Weapon +1.", upcast: "+2 at 4th, +3 at 6th.",
                 roll: {type: "buff", desc: "Weapon is now +1 (magic)."}},
                {name: "Warding Bond", level: 2, school: "Abjur", desc: "Share damage.", upcast: null,
                 roll: {type: "buff", desc: "Bonded to ally: +1 AC/Save, share damage."}},
                {name: "Lesser Restoration", level: 2, school: "Abjur", desc: "Cure condition.", upcast: null,
                 roll: {type: "buff", desc: "Removed a condition from target."}},
                {name: "Shining Smite", level: 2, school: "Conc", desc: "+2d6 Radiant + Advantage.", upcast: "+1d6 damage per level.",
                 roll: {type: "buff", desc: "Next hit: +2d6 Radiant + Advantage on target."}}
            ]
        }
    };

    function getMod(score) { return Math.floor((score - 10) / 2); }
    function fmtSign(n) { return n >= 0 ? "+" + n : n; }

    function updateDashboard(lvl) {
        document.getElementById('lvl-badge').innerText = lvl;
        let data = { ...levels[lvl] }; 
        
        // --- 1. READ INPUTS ---
        const amuletEl = document.getElementById('amuletToggle');
        const hasAmulet = amuletEl ? amuletEl.checked : false;
        
        const blessEl = document.getElementById('buffBless');
        const isBless = blessEl ? blessEl.checked : false;
        
        const divineEl = document.getElementById('buffDivine');
        const isDivine = divineEl ? divineEl.checked : false;

        // --- Accumulate Features ---
        let allFeatures = [];
        for (let i = 1; i <= lvl; i++) {
            if (levels[i].features) allFeatures = [...allFeatures, ...levels[i].features];
        }

        // --- Stats ---
        const mods = {
            str: getMod(data.str), dex: getMod(data.dex), con: getMod(data.con),
            int: getMod(data.int), wis: getMod(data.wis), cha: getMod(data.cha)
        };

        for (const [key, val] of Object.entries(data)) {
            if (['str','dex','con','int','wis','cha'].includes(key)) {
                document.getElementById(key).innerText = val;
                document.getElementById(`${key}-mod`).innerText = fmtSign(mods[key]);
            }
        }
        document.getElementById('prof-bonus').innerText = fmtSign(data.prof);
        
        // Initiative
        const initMod = mods.dex + data.prof;
        document.getElementById('init-val').innerText = fmtSign(initMod);

        // --- Aura Bonus ---
        let auraBonus = (lvl >= 6) ? Math.max(1, mods.cha) : 0;

        // --- Saving Throws (Apply Bless) ---
        const savesContainer = document.getElementById('saves-container');
        savesContainer.innerHTML = '';
        const saves = [
            {name: "Strength", mod: mods.str, prof: false},
            {name: "Dexterity", mod: mods.dex, prof: false},
            {name: "Constitution", mod: mods.con, prof: false},
            {name: "Intelligence", mod: mods.int, prof: false},
            {name: "Wisdom", mod: mods.wis, prof: true},
            {name: "Charisma", mod: mods.cha, prof: true}
        ];

        saves.forEach(s => {
            const total = s.mod + (s.prof ? data.prof : 0) + auraBonus;
            const cls = s.prof ? 'skill-prof' : '';
            // Bless Logic
            let sign = fmtSign(total);
            if(isBless) sign += " + 1d4";
            
            savesContainer.innerHTML += `<div class="skill-row"><span class="${cls}">${s.name}</span> <span class="${cls}">${sign}</span></div>`;
        });
        
        if (lvl >= 6) {
            savesContainer.innerHTML += `<div style="font-size:0.75em; color:var(--magic); text-align:center; margin-top:5px;">Aura of Protection (+${auraBonus})</div>`;
        }

        // --- Skills ---
        const skillsContainer = document.getElementById('skills-container');
        skillsContainer.innerHTML = '';
        const currentProfs = lvl >= 3 ? proficientSkills[3] : proficientSkills[1];
        allSkills.forEach(skill => {
            const mod = mods[skill.ability];
            const isProf = currentProfs.includes(skill.name);
            const total = mod + (isProf ? data.prof : 0);
            const cls = isProf ? 'skill-prof' : '';
            const star = isProf ? ' ★' : '';
            skillsContainer.innerHTML += `<div class="skill-row"><span class="${cls}">${skill.name}${star}</span> <span class="${cls}">${fmtSign(total)}</span></div>`;
        });

        // --- Combat Stats ---
        let ac = (lvl < 3) ? (12 + mods.dex) : (10 + mods.dex + mods.cha + 2);
        document.getElementById('ac-val').innerText = ac;

        // Attack Math (Apply Bless/Divine Favor)
        const hitMod = mods.dex + data.prof;
        const dmgMod = mods.dex;
        
        let hitText = fmtSign(hitMod);
        if(isBless) hitText += " + 1d4";
        
        let bonusDmg = isDivine ? "+1d4" : "";
        
        document.getElementById('wep1-hit').innerText = hitText + " Hit";
        document.getElementById('wep1-dmg').innerText = `1d6${fmtSign(dmgMod)}${bonusDmg}`;

        const offhandMod = (lvl >= 2) ? dmgMod : 0;
        document.getElementById('wep2-hit').innerText = hitText + " Hit";
        document.getElementById('wep2-dmg').innerText = `1d6${offhandMod !== 0 ? fmtSign(offhandMod) : ''}${bonusDmg}`;
        document.getElementById('twf-mod').style.display = (lvl >= 2) ? 'inline' : 'none';

        // Spell Stats
        const spellAtk = mods.cha + data.prof + (hasAmulet ? 1 : 0);
        const spellDC = 8 + mods.cha + data.prof + (hasAmulet ? 1 : 0);
        document.getElementById('spell-hit').innerText = fmtSign(spellAtk) + " Hit";
        document.getElementById('spell-atk').innerText = fmtSign(spellAtk);
        document.getElementById('spell-dc').innerText = spellDC;

        // --- Features Render ---
        const featContainer = document.getElementById('features-container');
        featContainer.innerHTML = '';
        allFeatures.forEach(f => {
            let item = document.createElement('div');
            item.className = 'feature-item';
            item.innerHTML = `<span class="feat-name">${f.name} <span class="feat-source">${f.source}</span></span><div class="feat-desc">${f.desc}</div>`;
            featContainer.appendChild(item);
        });

        document.getElementById('loh-val').innerText = lvl * 5;
        document.getElementById('smite-resource').style.display = (lvl >= 2) ? 'block' : 'none';
        
        // --- STEED / OSTRICH (Hover Logic Updated) ---
        const steedCard = document.getElementById('steed-resource');
        if (lvl >= 5) {
            steedCard.style.display = 'block';
            
            const slotLvl = 2; 
            const steedHP = 5 + (10 * slotLvl); // 25
            const steedAC = 13 + slotLvl;       // 15
            const steedDmg = `1d8+${mods.cha + slotLvl}`;
            
            document.getElementById('sb-ac').innerText = steedAC;
            document.getElementById('sb-hp').innerText = steedHP;
            document.getElementById('sb-atk').innerText = fmtSign(spellAtk);
            document.getElementById('sb-dmg').innerText = steedDmg;
        } else {
            steedCard.style.display = 'none';
        }

        // --- Channel Divinity (Interactive Pips) ---
        const cdCard = document.getElementById('cd-resource');
        if (lvl >= 3) {
            const totalCD = 2 + (hasAmulet ? 1 : 0);
            cdCard.style.display = 'block';
            
            // Generate Pips HTML
            let pipHTML = '';
            for(let i=0; i<totalCD; i++) {
                pipHTML += `<div class="cd-pip" onclick="this.classList.toggle('used')"></div>`;
            }
            
            cdCard.innerHTML = `
                <div class="attack-header">
                    <span>Channel Divinity</span> 
                    <div>${pipHTML}</div>
                </div>
                <div class="attack-detail" style="margin-top:8px;">
                    <div style="margin-bottom:8px; padding-bottom:6px; border-bottom:1px solid #475569;">
                        <strong style="color:var(--text-main);">1. Divine Sense</strong> <span class="kw-bonus">(Bonus Action)</span><br>
                        <span style="color:#94a3b8;">Detect Celestials, Fiends, Undead (10 min).</span>
                    </div>
                    <div>
                        <strong style="color:var(--text-main);">2. Elemental Smite</strong> <span style="font-style:italic; color:#94a3b8;">(No Action)</span><br>
                        <span style="color:#94a3b8;">Trigger after using Divine Smite:</span>
                        <ul style="margin:4px 0 0 18px; padding:0; list-style-type:disc; color:#cbd5e1; line-height:1.4;">
                            <li><b style="color:var(--dex-highlight)">Dao:</b> Grappled + Restrained (Str Save).</li>
                            <li><b style="color:var(--dex-highlight)">Djinni:</b> Teleport 9m + Resist B/P/S.</li>
                            <li><b style="color:var(--dex-highlight)">Efreeti:</b> +2d4 Fire damage.</li>
                            <li><b style="color:var(--dex-highlight)">Marid:</b> Push 4.5m + Prone AOE (Str Save).</li>
                        </ul>
                    </div>
                </div>
            `;
        } else {
            cdCard.style.display = 'none';
        }

        // --- Slots ---
        const slots = spellSlotsByLevel[lvl];
        const slotContainer = document.getElementById('slot-container');
        slotContainer.innerHTML = '';
        
        const maxHpEl = document.getElementById('max-hp');
        const curHpEl = document.getElementById('current-hp');
        if (maxHpEl.innerText != data.hp) curHpEl.value = data.hp;
        maxHpEl.innerText = data.hp;

        if (slots[0] > 0) {
            let row1 = `<div class="slot-row"><div class="slot-lvl">1st</div>`;
            for(let i=0; i<slots[0]; i++) row1 += `<div class="slot-pip" onclick="this.classList.toggle('used')"></div>`;
            row1 += `</div>`;
            slotContainer.innerHTML += row1;
        }
        if (slots[1] > 0) {
            let row2 = `<div class="slot-row"><div class="slot-lvl">2nd</div>`;
            for(let i=0; i<slots[1]; i++) row2 += `<div class="slot-pip" onclick="this.classList.toggle('used')"></div>`;
            row2 += `</div>`;
            slotContainer.innerHTML += row2;
        }

        // --- Spells Render ---
        const spellListEl = document.getElementById('spells-list');
        spellListEl.innerHTML = '';
        
        function drawSpell(s, typeClass) {
            let note = s.note ? `<span class="spell-note">${s.note}</span>` : '';

            // OnClick Logic for interactive spells
            let clickAttr = '';
            let hoverClass = '';

            if (s.roll) {
                const safeName = s.name.replace(/'/g, "\\'");
                const safeType = s.roll.type;
                const safeDice = s.roll.dice || '';
                const safeDesc = (s.roll.desc || s.desc || '').replace(/'/g, "\\'");
                const safeSave = s.roll.save || '';

                clickAttr = `onclick="castSpell('${safeName}', '${safeType}', '${safeDice}', '${safeDesc}', '${safeSave}')"`;
                hoverClass = 'attack-card';
            }

            let tooltipContent = `<strong style="color:var(--dex-highlight)">${s.name}</strong><br>${s.desc || ''}`;
            if (s.upcast) {
                tooltipContent += `<div style="margin-top:8px; padding-top:8px; border-top:1px solid #475569; font-style:italic; color:#fff;">At Higher Levels:<br><span style="color:#cbd5e1; font-style:normal;">${s.upcast}</span></div>`;
            }
            let tooltip = `<span class="spell-tooltip">${tooltipContent}</span>`;

            let rightSide = s.usage
                ? `<span class="spell-usage">${s.usage}</span>`
                : `<span class="spell-meta">${s.school || 'Spell'}</span>`;

            return `<div class="spell-item ${typeClass} ${hoverClass}" ${clickAttr}>
                        <span class="spell-name">${s.name}</span>
                        ${rightSide}
                        ${tooltip}
                    </div>${note}`;
        }

        let allSpells = [];

        magicInitiateSpells.forEach(s => {
            let usage = (s.name === "Shield") ? "1/LR" : null;
            allSpells.push({...s, typeClass: 'cantrip', usage: usage});
        });

        if (lvl >= 2) {
            allSpells.push({
                name: "Divine Smite", level: 1, school: "Evoc", typeClass: "always", usage: "1 Free/LR",
                note: "BA after hit. 2d8 Radiant.", 
                desc: "Bonus Action immediately after hitting a creature. Expend a spell slot to deal 2d8 Radiant damage.",
                upcast: "+1d8 damage per slot level above 1st (Max 5d8)."
            });
            if (lvl >= 5) {
                allSpells.push({
                    name: "Find Steed", level: 2, school: "Conj", typeClass: "always", usage: "1 Free/LR",
                    note: "Faithful Steed", 
                    desc: "Summon a spirit (Camel, Elk, Mastiff, etc). Long Rest cast.",
                    upcast: "Spells targeting only you also target your steed."
                });
            }
        }

        if (lvl >= 3) {
            for (let spellLvl = 3; spellLvl <= lvl; spellLvl++) {
                if (genieSpellsByLevel[spellLvl]) {
                    genieSpellsByLevel[spellLvl].forEach(s => allSpells.push({...s, typeClass: 'genie'}));
                }
            }
        }

        data.prepared.forEach(s => allSpells.push({...s, typeClass: 'paladin'}));

        allSpells.sort((a, b) => {
            if (a.level !== b.level) return a.level - b.level;
            return a.name.localeCompare(b.name);
        });

        const prepLimit = preparedSpellsByLevel[lvl];
        document.getElementById('prep-count').innerText = data.prepared.length;
        document.getElementById('prep-limit').innerText = prepLimit;

        const presentLevels = [...new Set(allSpells.map(s => s.level))].sort((a,b)=>a-b);

        presentLevels.forEach(levelNum => {
            let label = (levelNum === 0) ? "Cantrips" : (levelNum === 1) ? "1st Level" : (levelNum === 2) ? "2nd Level" : (levelNum === 3) ? "3rd Level" : `${levelNum}th Level`;
            spellListEl.innerHTML += `<div class="spell-category">${label}</div>`;
            const spellsAtLevel = allSpells.filter(s => s.level === levelNum);
            spellsAtLevel.forEach(s => {
                spellListEl.innerHTML += drawSpell(s, s.typeClass);
            });
        });
        
        // Legend Key
        spellListEl.innerHTML += `<div class="rules-note">
            <strong>Key:</strong> <span style="color:#fff">⬜ Cantrip</span><br>
            <div style="margin-top:4px; display:flex; gap:10px; align-items:center;">
                <span style="background:rgba(45, 212, 191, 0.2); border:1px solid var(--dex-highlight); padding:2px 6px; border-radius:4px; color:#fff;">Blue Background = Prepared</span>
            </div>
            <div style="margin-top:4px; font-size:0.9em; color:#94a3b8;">
                <span style="color:var(--dex-highlight)">▍Choice</span> &nbsp;
                <span style="color:var(--accent)">▍Genie</span> &nbsp;
                <span style="color:var(--success)">▍Free</span>
            </div>
        </div>`;
    }

    // --- NEW JS LOGIC ---

    // 1. Short Rest Logic
    function shortRest() {
        // Reset Channel Divinity Pips
        const pips = document.querySelectorAll('.cd-pip');
        pips.forEach(p => p.classList.remove('used'));

        // Heal Logic (Optional: Paladins usually heal on Long Rest, but let's simulate spending hit dice)
        const max = parseInt(document.getElementById('max-hp').innerText);
        const curInput = document.getElementById('current-hp');
        let current = parseInt(curInput.value);

        // Simple logic: Heal 50% of missing health on Short Rest
        if(current < max) {
            let heal = Math.floor((max - current) / 2);
            if(heal < 1) heal = 1;
            curInput.value = Math.min(max, current + heal);
            logMsg(`Short Rest: Recovered CD & ${heal} HP.`);
        } else {
            logMsg(`Short Rest: Recovered Channel Divinity.`);
        }
    }

    // 2. Dice Roller Logic
    function rollAttack(name, hitId, dmgId) {
        // Get Hit Mod (e.g., "+5 Hit" -> 5)
        const hitText = document.getElementById(hitId).innerText;
        const hitMod = parseInt(hitText.replace(/[^0-9-]/g, '')); // Extracts number

        // Get Dmg String (e.g., "1d6+3")
        let dmgText = document.getElementById(dmgId).innerText.split(' ')[0]; // Take first part "1d6+3"

        // Roll d20
        const d20 = Math.floor(Math.random() * 20) + 1;
        let hitTotal = d20 + hitMod;

        // Crit Logic
        let isCrit = (d20 === 20);
        let isFail = (d20 === 1);

        // Roll Damage
        let dmgTotal = 0;

        // Parse "1d6+3" or "2d6"
        // Regex matches: (Count)d(Faces)(Modifier)
        const regex = /(\d+)d(\d+)([+-]\d+)?/;
        const match = dmgText.match(regex);

        if (match) {
            let count = parseInt(match[1]);
            let faces = parseInt(match[2]);
            let mod = match[3] ? parseInt(match[3]) : 0;

            if (isCrit) count *= 2; // Double dice on crit

            let rolls = [];
            for(let i=0; i<count; i++) {
                let r = Math.floor(Math.random() * faces) + 1;
                rolls.push(r);
                dmgTotal += r;
            }
            dmgTotal += mod;

            // Log Formatting
            let hitClass = isCrit ? 'log-crit' : (isFail ? 'log-fail' : '');
            let hitDisplay = isCrit ? 'NAT 20!' : (isFail ? 'MISS (1)' : hitTotal);

            logMsg(`<strong>${name}:</strong> Attack <span class="${hitClass}">[${hitDisplay}]</span> | Dmg: <strong>${dmgTotal}</strong> (${rolls.join('+')}${mod >=0 ? '+'+mod : mod})`);
        } else {
            logMsg(`Error parsing damage: ${dmgText}`);
        }
    }

    function logMsg(html) {
        const log = document.getElementById('combat-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `> ${html}`;
        log.prepend(entry); // Add to top
    }

    // --- SPELLCASTING LOGIC ---

    function castSpell(name, type, diceStr, desc, saveStat) {
        // Get current Stats
        const spellAtk = parseInt(document.getElementById('spell-atk').innerText.replace('+',''));
        const spellDC = document.getElementById('spell-dc').innerText;
        const chaMod = parseInt(document.getElementById('cha-mod').innerText.replace('+',''));

        // Replace "MOD" in dice string with actual Charisma Modifier (e.g. "2d8+MOD" -> "2d8+3")
        let actualDice = diceStr.replace('MOD', chaMod);

        if (type === 'attack') {
            // Logic similar to weapon attack
            const d20 = Math.floor(Math.random() * 20) + 1;
            const isCrit = (d20 === 20);
            const isFail = (d20 === 1);
            const totalHit = d20 + spellAtk;

            // Calculate Damage
            let dmgResult = parseAndRoll(actualDice, isCrit);

            let hitClass = isCrit ? 'log-crit' : (isFail ? 'log-fail' : '');
            let hitDisplay = isCrit ? 'NAT 20!' : (isFail ? 'MISS (1)' : totalHit);

            logMsg(`<strong>${name}:</strong> Spell Attack <span class="${hitClass}">[${hitDisplay}]</span> | Dmg: <strong>${dmgResult.total}</strong> (${dmgResult.formula})`);

        } else if (type === 'save') {
            logMsg(`<strong>${name}:</strong> Cast! DC <span style="color:var(--magic); font-weight:bold;">${spellDC}</span> ${saveStat} Save. <br><span style="color:#cbd5e1; font-size:0.9em;">Effect: ${desc}</span>`);

        } else if (type === 'heal') {
            let healResult = parseAndRoll(actualDice, false);
            logMsg(`<strong>${name}:</strong> <span style="color:var(--success)">Healed <strong>${healResult.total}</strong> HP</span> (${healResult.formula})`);

            // Auto-update current HP input
            const curEl = document.getElementById('current-hp');
            const max = parseInt(document.getElementById('max-hp').innerText);
            curEl.value = Math.min(max, parseInt(curEl.value) + healResult.total);

        } else if (type === 'buff' || type === 'info') {
            logMsg(`<strong>${name}:</strong> ${desc}`);
        }
    }

    // Helper to roll dice strings like "2d8+3" or "1d10"
    function parseAndRoll(diceStr, isCrit) {
        const regex = /(\d+)d(\d+)([+-]\d+)?/;
        const match = diceStr.match(regex);

        if (!match) return { total: 0, formula: 'error' };

        let count = parseInt(match[1]);
        let faces = parseInt(match[2]);
        let mod = match[3] ? parseInt(match[3]) : 0;

        if (isCrit) count *= 2;

        let total = 0;
        let rolls = [];
        for(let i=0; i<count; i++) {
            let r = Math.floor(Math.random() * faces) + 1;
            rolls.push(r);
            total += r;
        }
        total += mod;

        // Format: "4+2+3"
        let formula = rolls.join('+') + (mod !== 0 ? (mod > 0 ? `+${mod}` : mod) : '');
        return { total, formula };
    }

    // Initialize
    updateDashboard(1);
</script>

</body>
</html>